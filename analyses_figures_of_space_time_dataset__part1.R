########################################       Generation of space-time dataset       #######################################
########################################### For Testing MSSA-MEOT and S-T mode PCA #####################################
#This script performs analyses and produces figures for synthetic space time datasets in R to test EOT,MEOT,PCA and MSSA.
#Space-time series were generated by combining a set of spatial patterns and temporal patterns. 
#This script uses 11 functions stored in a separate file: generation_of_space_time_dataset_functions_12312013.R.
#AUTHORS: Benoit Parmentier                                             
#DATE CREATED: 12/31/2013 
#DATE MODIFIED: 01/21/2014
#PROJECT: Clark Labs, MEOT, time series             
#TO DO:
###################################################################################################

###Loading R library and packages                                                      

library(gtools)   # loading various useful tools such as mixedsort 
library(sp)        #Spatial object models and functionality
library(raster)    #Raster functionality
library(rasterVis) #Raster visualization
library(rgdal)     #GDAL binding
library(vegan) 
library(parallel)   # parallelization based on snow
library(mgcv)                                # GAM package by Simon Wood
library(spdep)                               # Spatial pacakge with methods and spatial stat. by Bivand et al.
library(gstat)                               # Kriging and co-kriging by Pebesma et al.
library(fields)                              # NCAR Spatial Interpolation methods such as kriging, splines
library(foreign)                             # Library for format exchange (e.g. dbf,spss,sas etc.)
library(gdata)                               # various tools with xls reading
library(xts)                                 # basic package for time series analysis
library(zoo)                                 # basic package for time series analysis
library(forecast)                            # package containing ARIMA procedures
library(plotrix)
library(matrixStats) 
library(colorRamps)                         #Color palettes for raster images
library(gridExtra)
library(foreign)                             # Library for format exchange (e.g. dbf,spss,sas etc.)
library(gdata)                               # various tools with xls reading
library(xts)                                 # basic package for time series analysis
library(zoo)                                 # basic package for time series analysis
library(forecast)                            # package containing ARIMA procedures

##### Functions used in this script #####

functions_generation_space_time_datasets <- "generation_of_space_time_dataset_functions_12312013v6.R"

script_path<-"/Users/benoitparmentier/Dropbox/Data/MEOT_paper/" #path to script
source(file.path(script_path,functions_generation_space_time_datasets)) #source all functions used in this script.

## create function to assemble the meot indices in a table...

plot_temporal_components_IDRISI_ETM_proj <-function(folder_components,pattern_str,out_dir,out_suffix){
  #Plot output components from ETM in IDRISI
  
  list_temporal_component_files <- mixedsort(list.files(pattern="*.avl$",folder_components,full.names=T))
  list_temp_profiles <- lapply(1:length(pattern_str),function(k){grep(pattern=pattern_str[k],list_temporal_component_files,value=TRUE)})
  
  #tmp_str <- strsplit(comp_files,"_")
  #comp_str <-unique(unlist(lapply(tmp_str,function(k){grep(pattern="Comp*",k,value=TRUE)})))
  #no_comp <- length(comp_str) #number of components in the analysis
  
  combine_time_profiles_comp<-function(list_time_profiles){
    list_df <- lapply(list_time_profiles,read.table)
    list_df <- lapply(list_df,FUN=function(x){x[,2]})
    df <-do.call(cbind,list_df)
    df <- as.data.frame(df)
    names_str <- paste("comp",1:ncol(df),sep="_")
    names(df)<- names_str
    return(df)
  }
  
  l_df<-lapply(list_temp_profiles,FUN=combine_time_profiles_comp)
  names(l_df) <- pattern_str
  
  ## Now plot...
  #list_plots_obj <- vector("list",length=no_comp) 
  return(l_df)
  
}

plot_components_IDRISI_ETM_proj <-function(components_folders,comp_files,out_dir,out_suffix,r_mask=NULL,
                                           res_pix=480,col_mfrow=1,row_mfrow=1){
  #Plot output components from ETM in IDRISI
  
  tmp_str <- strsplit(comp_files,"_")
  comp_str <-unique(unlist(lapply(tmp_str,function(k){grep(pattern="Comp*",k,value=TRUE)})))
  comp_file_str <- paste(comp_str,"_R.rst",sep="") #components end string 
  no_comp <- length(comp_str) #number of components in the analysis
  
  list_MEOT_Lag_analyses_comp <- lapply(1:length(comp_file_str),function(k){grep(pattern=comp_file_str[k],comp_files,value=TRUE)})
  
  list_plots_obj <- vector("list",length=no_comp) 
  
  list_raster_name <- vector("list",length=1)
  for(i in 1:length(comp_str)){
    
    comp_str_processed <- comp_str[i]      
    list_r_comp_s <- file.path(folder_components,list_MEOT_Lag_analyses_comp[[i]])
    r_comp_s <- stack(mixedsort(list_r_comp_s))
    if (!is.null(r_mask)){
      r_comp_s <- mask(r_comp_s,r_mask)
    }
    layerNames(r_comp_s)<-paste(comp_str_processed,1:nlayers(r_comp_s),sep="_")
    temp.colors <- matlab.like(100)
    #levelplot(r_stack,layers=1:48, col.regions=temp.colors)
    p <- levelplot(r_comp_s, col.regions=temp.colors,main=paste(comp_str_processed,"_",out_suffix,sep=""))
    
    #How to match to 24 by 12 (width and height)
    #res_pix<-480 #set as function argument...
    #col_mfrow<-1
    #row_mfrow<-2
    #row_mfrow<-1
    
    png_file_name<- paste("Figure_",comp_str_processed,"_",paste(out_suffix,sep=""),".png", sep="")
    png(filename=file.path(out_dir,png_file_name),
        width=col_mfrow*res_pix,height=row_mfrow*res_pix)
    par(mfrow=c(row_mfrow,col_mfrow))
    
    print(p) #plot now
    dev.off()
    
    list_plots_obj[[i]] <- p
  }
  return(list_plots_obj)
}


plot_components_by2_IDRISI_ETM_proj <-function(components_folders,comp_files,out_dir,out_suffix){
  #Plot output components from ETM in IDRISI
  
  tmp_str <- strsplit(comp_files,"_")
  comp_str <-unique(unlist(lapply(tmp_str,function(k){grep(pattern="Comp*",k,value=TRUE)})))
  no_comp <- length(comp_str) #number of components in the analysis
  
  list_MEOT_Lag_analyses_comp <- lapply(1:length(comp_str),function(k){grep(pattern=comp_str[k],comp_files,value=TRUE)})
  
  
  list_raster_name <- vector("list",length=1)
  for(i in 1:length(comp_str)){
    
    comp_str_processed <-comp_str[i]      
    list_r_comp_s <- file.path(folder_components,list_MEOT_Lag_analyses_comp[[i]])
    r_comp_s <- stack(mixedsort(list_r_comp_s))
    layerNames(r_comp_s)<-paste(comp_str_processed,1:nlayers(r_comp_s),sep="_")
    temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
    temp.colors <- matlab.like(18)
    #levelplot(r_stack,layers=1:48, col.regions=temp.colors)
    p <- levelplot(r_comp_s, col.regions=temp.colors,main=paste(comp_str_processed,"_",out_suffix,sep=""))
    
    res_pix<-480
    col_mfrow<-1
    #row_mfrow<-2
    row_mfrow<-1
    
    png_file_name<- paste("Figure_",comp_str_processed,"_",paste(out_suffix,sep=""),".png", sep="")
    png(filename=file.path(out_dir,png_file_name),
        width=col_mfrow*res_pix,height=row_mfrow*res_pix)
    par(mfrow=c(row_mfrow,col_mfrow))
    
    print(p)
    dev.off()
  }
}

crosscor_lag_analysis_fun<-function(telind,mode_list,d_z,lag_window,fig,out_prefix){
  #This function crosss correlates between two sets of time series given some lag window.
  #Arguments:
  #1)telind: time series 1 as character vector
  #2)modelist: time series 2 as character vector
  #3)d_z: zoo object 
  #4)lag_window:
  #5)fig:
  
  lag_table_ext<-matrix(data=NA,nrow=length(telind),ncol=length(mode_list))
  lag_table_lag<-matrix(data=NA,nrow=length(telind),ncol=length(mode_list))
  lag_table_text<-matrix(data=NA,nrow=length(telind),ncol=length(mode_list)) #Formatted table used in the paper
  #lag_cross_cor_PCA<-vector("list",length(mode_list))
  lag_m<-seq(-1*lag_window,lag_window,1)
  #retain ccf!!!
  #list_ccf_lag_table
  
  #lag_cross_cor_PCA_m<-array(data=NA,nrow=length(lag_m),ncol=length(mode_list))
  for (i in 1:length(telind)){
    telindex<-telind[i]
    pos1<-match(telindex,names(d_z))
    #retain ccf!!!
    for (j in 1:length(mode_list)){
      mode_n<-mode_list[j]
      pos2<-match(mode_n,names(d_z))
      ccf_obj<-ccf(d_z[,pos1],d_z[,pos2], lag=lag_window)  #Note that ccf does not take
      
      lag_m<-seq(-1*lag_window,lag_window,1)
      ccf_obj$lag[,1,1]<-lag_m  #replacing lag values because continuous
      
      if (fig=="TRUE"){
        plot_name<-paste(telindex, "and", mode_n,"lag analysis",sep="_")
        png(paste(plot_name,"_",out_prefix,".png", sep=""))
        plot(ccf_obj, main= paste(telindex, "and", mode_n,"lag analysis",sep=" "), ylab="Cross-correlation",
             xlab="Lag (month)", ylim=c(-1,1))
        dev.off()
      }
      
      ######### NOW FIND THE m
      absext <-max(abs(ccf_obj$acf)) # maximum of the extremum
      pos<-match(absext,ccf_obj$acf) #find the position and lag, if NA it means it was negative
      if (is.na(pos)) {
        pos<-match(absext*-1,ccf_obj$acf)
        absext<-absext*-1   #recover the sign
      } 
      absext_lag<-ccf_obj$lag[pos,1,1] #This is the lag corresponding to the maximum absolute value
      
      lag_table_ext[i,j]<-absext
      lag_table_lag[i,j]<-absext_lag
      #number<-format(absext,digits=3)
      ext<-round(absext,digits=3)
      element<-paste(ext," (",absext_lag,")",sep="")
      lag_table_text[i,j]<-element
      
      ##Keep ccf lag somewhere
    }
  }
  
  lag_table_ext<-as.data.frame(lag_table_ext)
  names(lag_table_ext)<-mode_list
  rownames(lag_table_ext)<-telind
  file_name<-paste("lag_table_extremum_window_", lag_window,"_",out_prefix,".txt",sep="")
  write.table(lag_table_ext,file=file_name,sep=",")
  
  lag_table_lag<-as.data.frame(lag_table_lag)
  names(lag_table_lag)<-mode_list
  rownames(lag_table_lag)<-telind
  file_name<-paste("lag_table_lag_extremum_window_", lag_window,"_",out_prefix,".txt",sep="")
  write.table(lag_table_lag,file=file_name,sep=",")
  
  lag_table_text<-as.data.frame(lag_table_text)
  names(lag_table_text)<-mode_list
  rownames(lag_table_text)<-telind
  file_name<-paste("lag_table_lag_ext_text", lag_window,"_",out_prefix,".txt",sep="")
  write.table(lag_table_text,file=file_name,sep=",")
  
  #create return object
  
  crosscor_obj<-list(lag_table_ext,lag_table_lag,lag_table_text)
  names(crosscor_obj)<-c("extremum","lag_ext","text")
  file_name<-paste("crosscor_obj_lag_analysis_", lag_window,"_",out_prefix,".RData",sep="")
  save(crosscor_obj,file=file_name)
  
  return(crosscor_obj)
}

############# Parameters and arguments ####################

out_suffix <-"MEOT_s11_L24_01162014"
#in_dir<- "/Users/benoitparmentier/Documents/DATA/Benoit/Clark_University/Paper_writings/MSSA_BNP/work_dir6_01172014"
#r_mask_file <- "/Users/benoitparmentier/Documents/DATA/Benoit/Clark_University/Paper_writings/MSSA_BNP/SST_1982_2007_Data/mask_rgf_1_1.rst"

in_dir <- "/Users/benoitparmentier/Documents/DATA/Benoit/Clark_University/Paper_writings/MSSA_BNP/work_dir5_01102013"
out_dir<- "/Users/benoitparmentier/Documents/DATA/Benoit/Clark_University/Paper_writings/MSSA_BNP/"

out_dir_name <- paste("analyses_and_figures","_",out_suffix,sep="")
out_dir <- file.path(out_dir,out_dir_name)
if (!file.exists(out_dir)){
  dir.create(out_dir)
}
setwd(out_dir)

############## PART I : MEOT WITH SINUSOIDAL PATTERN ###############

sine_inDir <- "/Users/benoitparmentier/Documents/Data/Benoit/Clark_University/Paper_writings/MSSA_BNP/work_dir5_01102013/sine9x9_90"

r_test_sine <- stack(list.files(pattern="sine9x9_90.*.rst$",path=sine_inDir,full.names=T))

#r_meot_list <- list.files(pattern="Cover9.*.rst$",path=sine_inDir,full.names=T)
#nt <- 45
nt <- 90

r_agg <- aggregate(r_test_sine,fact=3,fun=mean) #
coords_xy <- coordinates(r_agg)
#Prepare time series profiles
pix_dat <- t(extract(r_test_sine,coords_xy))
pix_dat <- as.data.frame(pix_dat)
pix_dat <- pix_dat[,c(1,2,3,9,8,7,4,5,6)] #reorder pixels according to S shape

########### Plotting figures ###########

### Figure 1: Original signal...###
#1. images

layout_m <- c(1,1)
png(paste("Figure1a_","original_sine","_paper_revisions_supplement_",out_suffix,".png", sep=""),
    height=480*layout_m[1],width=480*layout_m[2]*1)
#height=3*480*layout_m[1],width=2*480*layout_m[2])
#height=480*6,width=480*4)
#par(mfrow=layout_m)    
names_panel_plot <- paste("T",1:9,sep="_")
r_pattern <- subset(r_test_sine,1:9)
layerNames(r_pattern) <- names_panel_plot
levelplot(r_pattern,col.regions=matlab.like(18))
dev.off()
#2. temporal profiles
#r_dat <- as(r_test_sine,"SpatialPointsDataFrame")
layout_m <- c(1,1)
png(paste("Figure1b_","original_image_time_series_1","_paper_revisions_supplement_",out_suffix,".png", sep=""),
    height=480*layout_m[1],width=480*layout_m[2]*1)

plot(subset(r_test_sine,1),col=matlab.like(18),
     legend.width=2, legend.shrink=0.75)
text(coords_xy[,1],coords_xy[,2],labels=c(1,2,3,9,8,7,4,5,6))
#text(coords_xy[,1],coords_xy[,2],labels=1:9)
dev.off()

png(paste("Figure1c_","original_sine_time_series","_paper_revisions_supplement_",out_suffix,".png", sep=""),
    height=480*layout_m[1],width=480*layout_m[2]*1)

#names_pix_blocks <-paste("B",c(1,2,3,9,8,7,4,5,6),sep="")
names_pix_blocks <-paste("B",1:9,sep="")

plot(ts(data=pix_dat,names=names_pix_blocks),main="Sinusoidal patterns for the 9 blocks",
     ylab="Amplitude",xlab="Time steps",pch=1,type="b")

dev.off()

########### Plotting figures 2 to figures 8: MEOT 9 sequences ###########

#Get all files relevant to components for supplementary material analyes
list_components_folders <- list.dirs(path=in_dir) #default uses recursive and full.names
list_components_folders <- mixedsort(grep("*.components$",list_components_folders,value=T))
list_components_folders <- (grep("test_sine9x9_90_",list_components_folders,value=T)) #get the sine9by9

#Modify later to auto detect?
pattern_str<- c("test_sine9x9_90_L2","test_sine9x9_90_L4","test_sine9x9_90_L5","test_sine9x9_90_L6",
                "test_sine9x9_90_L7","test_sine9x9_90_L8","test_sine9x9_90_L9","test_sine9x9_90_L18")
folder_components <-list_components_folders

#Select groups of files containing MEOT analyses
list_component_files <- mixedsort(list.files(pattern="*.Comp.*.R.rst$",list_components_folders[1]))
list_MEOT_Lag_analyses <- lapply(1:length(pattern_str),function(k){grep(pattern=pattern_str[k],list_component_files,value=TRUE)})

## Plot 

## Quick exploration of results
list_plots_meot_obj <- vector("list",length=length(list_MEOT_Lag_analyses))
#r44 <- raster("/Users/benoitparmentier/Documents/DATA/Benoit/Clark_University/Paper_writings/MSSA_BNP/SST_1982_2007_Data/mask_rgf_1_1.rst")

#Quick check...
out_suffix_s <- paste(pattern_str[1],out_suffix,sep="_") #Lag 2,Lag4 ... to Lag 18
#undebug(plot_components_IDRISI_ETM_proj)
#list_plots_meot_obj[[1]] <- plot_components_IDRISI_ETM_proj(folder_components,comp_files=list_MEOT_Lag_analyses[[1]] ,out_dir,out_suffix_s)
list_plots_meot_obj[[1]] <- plot_components_IDRISI_ETM_proj(folder_components,comp_files=list_MEOT_Lag_analyses[[1]] ,
                                                            out_dir,out_suffix_s,r_mask=NULL,
                                                            res_pix=480,col_mfrow=1,
                                                            row_mfrow=1)  
#put this in a loop..
for  (i in 1:length(list_plots_meot_obj)){
  out_suffix_s <- paste(pattern_str[i],out_suffix,sep="_") #Lag 2,Lag4 ... to Lag 18
  list_plots_meot_obj[[i]] <- plot_components_IDRISI_ETM_proj(folder_components,comp_files=list_MEOT_Lag_analyses[[i]] ,
                                                              out_dir,out_suffix_s,r_mask=NULL,
                                                              res_pix=480,col_mfrow=1,
                                                              row_mfrow=1)  
}

title_plots <- c("Lag window 2 MEOT","Lag window 4 MEOT", "Lag window 5 MEOT", "Lag window 6 MEOT",
                 "Lag window 7 MEOT","Lag window 8 MEOT","Lag window 9 MEOT","Lag window 18 MEOT")

for (i in 1:length(list_plots_meot_obj)){
  layout_m <- c(1,1)
  no_fig <-i+1
  png(paste("Figure",no_fig,"_paper_revisions_supplement_",out_suffix,".png", sep=""),
      height=480*layout_m[1],width=480*layout_m[2]*2)
  #height=3*480*layout_m[1],width=2*480*layout_m[2])
  #height=480*6,width=480*4)
  #par(mfrow=layout_m)    
  
  p_comp1 <- list_plots_meot_obj[[i]][[1]] 
  p_comp2 <- list_plots_meot_obj[[i]][[2]] 
  
  p_comp1$main <- paste(title_plots[[i]],1,sep="")
  p_comp2$main <- paste(title_plots[[i]],2,sep="")
  grid.arrange(p_comp1,p_comp2,ncol=2)
  
  dev.off()
}

######### Plot temporal profiles...

#### PLOT R
l_df <- plot_temporal_components_IDRISI_ETM_proj(folder_components,pattern_str,out_dir,out_suffix) 
#pattern_str<- c("sine9by9_L2","sine9by9_L4","sine9by9_L5","sine9by9_L8","sine9by9_L9","sine9by9_L18")
#pattern_str<- c("sine9x9_90_L2","sine9x9_90_L4","sine9x9_90_L5","sine9x9_90_L6",
#                "sine9x9_90_L8","sine9x9_90_L9","sine9x9_90_L18")

folder_components <- list_components_folders
df<- l_df[[1]]
names(df)

### Plot temporal profiles...
for (i in 1:length(l_df)){
  df <-l_df[[i]]
  layout_m <- c(1,1)
  no_fig <-i+1
  png(paste("Figure",no_fig,"_temporal_MEOT_paper_revisions_supplement_",out_suffix,".png", sep=""),
      height=480*layout_m[1],width=480*layout_m[2]*2)
  #height=3*480*layout_m[1],width=2*480*layout_m[2])
  #height=480*6,width=480*4)
  #par(mfrow=layout_m)    

  plot(df[,1],type="b",lty="solid",col="blue",main=paste(title_plots[[i]],1,sep=""),lwd=1.2,cex.main=1.2,cex.axis=1.2,font=2,
       xlab="Time steps",ylab="Amplitude",cex.lab=1.2, font.lab=2)
  lines(df[,2],type="b",lty=4 ,col="darkgreen",lwd=1.2)
  
  legend("topright",legend=c("MEOT1","MEOT2"), cex=0.8, col=c("blue","darkgreen"),
         lty=c(1,4),lwd=3,bty="n")  #lwd=line width
  dev.off()
}

############## PART II : RED NOISE ANALYSIS ###############

### ORIGINAL RED NOISE DATASET

rednoise_inDir <- "/Users/benoitparmentier/Documents/Data/Benoit/Clark_University/Paper_writings/MSSA_BNP/work_dir4_11252013/r2_rednoise_AR92_trend_x_gen_11252013"
r_test_rednoise <- stack(list.files(pattern="r2_rednoise_AR92_trend_x.*.rst$",path=rednoise_inDir,full.names=T))

nt <- 45

#Test some palettes
levelplot(r_test_rednoise,layers=1:9,col.regions=matlab.like(18))

#r_agg <- aggregate(r_test_sine,fact=3,fun=mean) #
#coords_xy <- coordinates(r_agg)

#rednoise_pix_dat <- as(r_test_rednoise,"SpatialPointsDataFrame")
rednoise_pix_dat <- as.matrix(r_test_rednoise)#,"SpatialPointsDataFrame")
rednoise_pix_dat <- t(rednoise_pix_dat)

########### Plotting figures ###########

### Figure 1: Original signal...###
#1. images

layout_m <- c(1,1)
png(paste("Figure1b_","rednoise_image_time_series_1","_paper_revisions_supplement_",out_suffix,".png", sep=""),
    height=480*layout_m[1],width=480*layout_m[2]*1)
names_panel_plot <- paste("T",1:9,sep="_")
r_pattern <- subset(r_test_rednoise,1:9)
layerNames(r_pattern) <- names_panel_plot
levelplot(r_pattern,col.regions=matlab.like(18))
dev.off()

#2. temporal profiles
#r_dat <- as(r_test_sine,"SpatialPointsDataFrame")

png(paste("Figure1c_","original_sine_time_series","_paper_revisions_supplement_",out_suffix,".png", sep=""),
    height=480*layout_m[1],width=480*layout_m[2]*1)

#names_pix_blocks <-paste("Pixel",c(1,2,3,9,8,7,4,5,6),sep="")
names_pix_blocks <-paste("Pixel_",1:9,sep="")
names(rednoise_pix_dat) <- names_pix_blocks

plot(ts(data=rednoise_pix_dat,names=names_pix_blocks),main="Red noise patterns for the 9 pixels",
     ylab="Amplitude",xlab="Time steps",pch=1,type="b")

dev.off()

### NOW USE MEOT ANALYSES RESULTS FOR MEOT

in_dir<- "/Users/benoitparmentier/Documents/Data/Benoit/Clark_University/Paper_writings/MSSA_BNP/work_dir4_11252013"

#Get all files relevant to components
list_components_folders <- list.dirs(path=in_dir) #default uses recursive and full.names
list_components_folders <- mixedsort(grep("*.components$",list_components_folders,value=T))
folder_components <- (grep("rednoise_AR92_trend_x_gen_11252013",list_components_folders,value=T)) #get the sine9by9

pattern_str<- c("r2_rednoise_AR92_trend_x")

list_component_files <- mixedsort(list.files(pattern="*.Comp.*.R.rst$",folder_components))
list_MEOT_Lag_analyses_rednoise <- lapply(1:length(pattern_str),function(k){grep(pattern=pattern_str[k],list_component_files,value=TRUE)})
list_MEOT_Lag_analyses_rednoise[[1]] <- list_MEOT_Lag_analyses_rednoise[[1]][1:45]
## Plot 

## Quick exploration of results
list_plots_meot_rednoise_obj <- vector("list",length=length(list_MEOT_Lag_analyses_rednoise))

out_suffix_s <- paste(pattern_str[1],out_suffix,sep="_") #Lag 9
list_plots_meot_rednoise_obj[[1]] <- plot_components_IDRISI_ETM_proj(components_folders,
                                                                     comp_files=list_MEOT_Lag_analyses_rednoise[[1]] ,out_dir,out_suffix_s)

list_plots_meot_rednoise_obj[[1]][[5]]

title_plots <- c("Lag window 9 MEOT")


for (i in 1:length(list_plots_meot_rednoise_obj)){
  plot_obj <- list_plots_meot_rednoise_obj[[i]]
  layout_m <- c(1,1)
  no_fig <-i+1
  png(paste("Figure",no_fig,"_rednoise_paper_revisions_supplement_",out_suffix,".png", sep=""),
      height=480*layout_m[1],width=480*layout_m[2]*2)
  #height=3*480*layout_m[1],width=2*480*layout_m[2])
  #height=480*6,width=480*4)
  #par(mfrow=layout_m)    
  
  p_comp1 <- plot_obj[[1]] 
  p_comp2 <- plot_obj[[2]] 
  
  p_comp1$main <- paste(title_plots[[i]],1,sep="")
  p_comp2$main <- paste(title_plots[[i]],2,sep="")
  grid.arrange(p_comp1,p_comp2,ncol=2)
  
  dev.off()
  
}

### Now temporal profiles...
pattern_str<- c("r2_rednoise_AR92_trend_x")
l_rednoise_df <- plot_temporal_components_IDRISI_ETM_proj(folder_components,pattern_str,out_dir,out_suffix) 

#pattern_str<- c("sine9by9_L2","sine9by9_L4","sine9by9_L5","sine9by9_L8","sine9by9_L9","sine9by9_L18")
#folder_components <-list_components_folders

title_plots <- c("Lag window 9 MEOT")

for (i in 1:length(l_rednoise_df)){
  df <-l_rednoise_df[[i]]
  layout_m <- c(1,1)
  no_fig <-i+1
  png(paste("Figure",no_fig,"_rednoise_temporal_MEOT_paper_revisions_supplement_",out_suffix,".png", sep=""),
      height=480*layout_m[1],width=480*layout_m[2]*2)
  
  plot(df[,1],type="b",lty="solid",col="blue",main=paste(title_plots[[i]],1,sep=""),lwd=1.2,cex.main=1.2,cex.axis=1.2,font=2,
       xlab="Time steps",ylab="Amplitude",cex.lab=1.2, font.lab=2)
  lines(df[,2],type="b",lty=4 ,col="darkgreen",lwd=1.2)
  
  legend("topright",legend=c("MEOT1","MEOT2"), cex=0.8, col=c("blue","darkgreen"),
         lty=c(1,4),lwd=3,bty="n")  #lwd=line width
  dev.off()
}

#####################################################
################    END OF SCRIPT    ##############

