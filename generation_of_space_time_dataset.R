########################################       Generation of space-time dataset       #######################################
########################################### For Testing MSSA-MEOT and S-T mode PCA #####################################
#This script generates synthetic space time dataset in R to test EOT,MEOT,PCA and MSSA.
#Output format can be chosen between IDRISI raster and tif.
#Space-time series can be generated by combining a set of spatial patterns and temporal patterns. 
#AUTHORS:Benoit Parmentier and Neeti Neeti                                                 
#DATE: 08/23/2013                                                                                
#PROJECT: Clark Labs, MEOT, time series                                  
###################################################################################################

###Loading R library and packages                                                      

library(gtools)                                        # loading some useful tools 
library(sp)
library(raster)
library(rasterVis)
library(rgdal)
library(vegan) 
library(zoo)

##### Functions used in this script #####

##Function to generate spatial image

generate_raster_region <-function(j,list_param){
  #This....
  #Arguments: no of image, no of rows and columns, projection, range of value to be used, distribution, output prefix, and output directory
  #Output: raster image in IDRISI format
  
  ## Parse input arguments
  
  j <- list_param$j
  col <- list_param$col
  row <- list_param$row
  proj_str <- list_param$proj_str
  range_val <- list_param$range_val
  distribution_val_i <- list_param$distribution_val_i
  out_suffix <- list_param$out_suffix
  out_dir <-list_param$out_dir
  list_param$NA_flag_val
  
  ## Start #
  
  if(distribution_val_i=="none"){
    pix_values <- rep(1,row*col)
  }
  if(distribution_val_i=="unif"){
    pix_values <- runif(row*col)
  }
  
  r<-raster(nrows=row, ncols=col,crs=proj_str,xmn=0, xmx = col, ymn=0, ymx=row)
  r <- setValues(r,pix_values)
  
  #Write out the raster defining the region
  raster_name<-paste("reg_raster","_",row, "r_", col,"c_",out_suffix, sep="")
  writeRaster(r, filename=raster_name,NAflag=NA_flag_val,bylayer=FALSE,bandorder="BSQ",overwrite=TRUE)  #Writing the data in a raster file format...  
  #return raster defining the extent and basis layer!!!
  return(r)
}

#Function to generate spatial structure
adding_sptatial_structure  <-function(j,list_param){
  
  #This....
  #Arguments: no of image, no of rows and columns, projection, range of value to be used, type of spatial pattern, output prefix, and output directory
  #Output: raster image in IDRISI format  
  #TO DO: modify for memory efficiency, write out individual raster images if necessary. 
  #Functions used in this code:
  
  sine_structure_fun <-function(x,T,phase,a,b){
    #Create sine for a one dimensional series
    #Note that sine function uses radian unit.
    #a=amplitude
    #b=mean or amplitude 0 of the series
    #T= stands for period definition
    #phase=phase angle (in radian!!)
    
    y <- a*sin((x*pi/T)+ phase) + b
  }
  
  ## Parse input arguments
  
  j <- list_param$j
  r <- list_param$r
  proj_str <- list_param$proj_str
  range_val <- list_param$range_val
  NA_flag_val <- list_param$NA_flag_val
  file_format <- list_param$file_format #".tif" or ".rst" for the time being
  #type_spatialstructure <- list_param$type_spatialstructure
  out_suffix <- list_param$out_suffix
  out_dir <-list_param$out_dir
  r <- list_param$r
  row <- nrow(r)  
  col<- ncol(r)
  
  ### Start #####
  
  type_spatialstructure <- character (length=15) #empty char vector to store names of spatial structures/raster layers 
  #Generate first spatial pattern: constant square   
  spstr<- r  
  type_spatialstructure[1] <- "constant_sqr"
  pix_values <- min(range_val)
  spstr <- setValues(spstr,pix_values)
  spstr[1:(row/2), 1:(col/2)] <- max(range_val)
  spstr[(row/2)+1:row, (col/2)+1:col] <- max(range_val)
  r1 <- spstr 
  
  #Generate spatial pattern 2: sine diagonal   
  type_spatialstructure[2] <- "sine_diag1" 
  pix_values <- min(range_val)
  spstr <- setValues(spstr,pix_values)
  x.coord <- rep(1:col, each=col)
  y.coord <- rep(1:row, times=row)
  xy <- data.frame(x.coord, y.coord)
  xy.dist <- dist(xy)
  pcnm.axes <- pcnm(xy.dist)$vectors
  z.value <- pcnm.axes[,1]*100 + rnorm(row*col, min(range_val), max(range_val))
  spstr[] <- z.value
  r2 <- spstr
  
  #Generate spatial pattern 3: trend in x    
  type_spatialstructure[3] <-"trend_x"
  u <-xFromCol(r,colnr=1:col)
  a<- 2 #slope
  b<- -1 #intercept
  ux <-  a*u + b  
  ux <-rep(ux,time=row)  
  r3<-setValues(r,ux)  
  
  #Generate spatial pattern 4: trend in y    
  type_spatialstructure[4] <-"trend_y"
  r4 <-t(r3)
  
  #Generate spatial pattern 5:     
  type_spatialstructure[5] <- "periodic_x1"
  u <- xFromCol(r,colnr=1:col)
  a<- 2 #amplitude in this case
  b<- 0
  T<- col
  phase <- 0
  ux <- sine_structure_fun(u,T,phase,a,b)
  ux <-rep(ux,time=row)  
  r5<-setValues(r,ux)  
  plot(r5)
  
  #Generate spatial pattern6:  
  type_spatialstructure[6] <- "periodic_y1"
  r6 <-t(r5)
  
  #Generate spatial pattern7:  
  type_spatialstructure[7] <- "periodic_xy1"
  r7 <- r5 + r6
  
  #Generate spatial pattern 8:     
  type_spatialstructure[8] <- "periodic_x2"
  u <- xFromCol(r,colnr=1:col)
  a<- 2 #amplitude in this case
  b<- 0
  T<- round(col/2)
  phase <- 0  
  ux <- sine_structure_fun(u,T,phase,a,b)
  ux <-rep(ux,time=row)  
  r8 <-setValues(r,ux)  

  #Generate spatial pattern 9:  
  type_spatialstructure[9] <- "periodic_y2"
  r9 <- t(r8)
  
  #Generate spatial pattern 10:  
  type_spatialstructure[10] <- "periodic_xy2"
  r10 <- r8 + r9
    
  #Generate spatial pattern 11:     
  type_spatialstructure[11] <- "periodic_x3"
  u <- xFromCol(r,colnr=1:col)
  a<- 2 #amplitude in this case, should be an argument of the function
  b<- 0
  T<- round(col/3)
  phase <- 0  
  ux <- sine_structure_fun(u,T,phase,a,b)
  ux <-rep(ux,time=row)  
  r11 <-setValues(r,ux)  
  
  #Generate spatial pattern 12:  
  type_spatialstructure[12] <- "periodic_y3"
  r12 <- t(r11)
  
  #Generate spatial pattern 13:  
  type_spatialstructure[13] <- "periodic_xy3"
  r13 <- r11 + r12
  
  #Generate spatial pattern 14:  
  type_spatialstructure[14] <- "constant" #This may contain randomness!!
  r14 <-r 
  
  #Generate spatial pattern 15: trend in xy, diagonal   
  type_spatialstructure[15] <-"trend_xy"
  r15 <- r3 + r4
  
  #TO DO later - Generate user defined patter: using a,b,phase and other inputs
  
  #Prepare stack to return object
  r_spat <-stack(r1,r2,r3,r4,r5,r6,r7,r8,r9,r10,r11,r12,r13,r14,r15)
  #names(r_spat) <- type_Spatialstructure
  layerNames(r_spat) <- type_spatialstructure
  
  #Write out spatial patterns
  if(file_format==".rst"){
    for (i in 1:nlayers(r_spat)){
      rast <-subset(r_spat,i)
      raster_name<-paste("raster","_",row, "r_", col,"c_","r_spat_s_",i,"_",
                         type_spatialstructure[i],"_",out_suffix,file_format, sep="")
      writeRaster(rast, NAflag=NA_flag_val,filename=raster_name,bylayer=FALSE,bandorder="BSQ",overwrite=TRUE)
    }
  }
  #now write out stack...
  if(file_format==".tif"){
  raster_name<-paste("raster","_",row, "r_", col,"c_","r_spat_s","_",out_suffix,file_format, sep="")
  writeRaster(r_spat, NAflag=NA_flag_val,filename=raster_name,bylayer=TRUE,bandorder="BSQ",overwrite=TRUE)   
  }

  return(r_spat)
}

#Function ....
adding_temporal_structure <-function(list_param){
  #This....
  #Arguments: no of image, no of rows and columns, projection, range of value to be used, type of spatial pattern, output prefix, and output directory
  #Output: raster image in IDRISI format  
  
  ##Functions used:
  
  temp_structure_fun <-function(x,T,phase){
    y <-sin((x*pi/T)+ phase)
  }
  
  ## Parse input arguments
  #j <- list_param$j
  nt <- list_param$nt
  phase <- list_param$phase
  temp_periods <- list_param$temp_periods
  temp_period_quadrature <- list_param$temp_period_quadrature
  
  ### Start #####
  
  #type_temporalstructure <- character (length=6)
  x<- as.numeric(1:nt)
  
  # Generate temporal signal with periodic signal
  
  y1_list<-vector("list",length=length(temp_periods))
  for (i in 1:length(temp_periods)){
    T<-temp_periods[i]
    y1_list[[i]] <- temp_structure_fun(x,T,phase)
  }
  names(y1_list) <- paste("t_period",temp_periods,sep="_")
  # Generate periodic Quadrature:
  
  T <- temp_period_quadrature
  y2_list<-vector("list",length=length(temp_periods))
  y2_list[[1]] <- temp_structure_fun(x,T,pi/2)
  y2_list[[2]] <- temp_structure_fun(x,T,0)
  
  y2<-y2_list[[1]] + y2_list[[2]]
  
  # Generate temporal trends
  a<- 0.1
  b<- 0
  y3 <-  a*x + b  
  
  # Generate temporal temporal randomness
  y4 <- runif(nt) 
  
  y5<- rnorm(nt)
  
  #Prepare return object
  dfrm1 <-do.call(cbind,y1_list)
  dfrm2 <- do.call(cbind,list(quadrature=y2,trend=y3,unif=y4,norm=y5))
  temp_pattern_dfrm <- (cbind(dfrm1,dfrm2)) #data.frame containing temporal patterns...
  temp_pattern_dfrm<-as.data.frame(temp_pattern_dfrm)
  #head(temp_pattern_dfrm)
  file_name<-paste("table_temporal_patterns","_",out_suffix,".txt",sep="")
  write.table(temp_pattern_dfrm,file=file_name,sep=",")
  
  return(temp_pattern_dfrm)
}

#generate stack given a raster image, this replicates the original image...
generate_stack_raster<-function(r,n_stack){
  pix_vals <-getValues(r)
  list_r<-vector("list",length=n_stack)
  for (i in 1:n_stack){
    list_r[[i]]<-r
  }
  r_stack<-stack(list_r)
}

#Function to combine time and space structure, given a stack of value and temporal index
combine_space_time_structure <-function(temp_pattern,r_stack,out_suffix,NA_flag_val,file_format,operation="addition"){
  #modify later for efficiency if needed, this is a small image!!!
  rast_ref <- raster(r_stack,1)
  r_list <-vector("list",length=nlayers(r_stack)) #contain rasters...
  list_raster_name <-vector("list",length=nlayers(r_stack)) #contain rasters...
  
  names(r_list) <- paste("ts",1:nlayers(r_stack),sep="_") #use names in new raster package
  for (k in 1:nlayers(r_stack)){
    pix_vals <-getValues(subset(r_stack,k))
    if(operation=="multiplication"){
      r_comb <- setValues(rast_ref,pix_vals*temp_pattern[k]) 
    }
    if(operation=="addition"){
      r_comb <- setValues(rast_ref,pix_vals+temp_pattern[k]) 
    }
    r_list[[k]] <- r_comb
    if(file_format==".rst"){
      raster_name<-paste("raster","_",row, "r_", col,"c_","ts_",k,"_",out_suffix,file_format, sep="")
      list_raster_name[[k]] <- raster_name
      writeRaster(r_comb, NAflag=NA_flag_val,filename=raster_name,bylayer=FALSE,bandorder="BSQ",overwrite=TRUE)
    }
  }
  r_temp <- stack(r_list)
  dat_list<-c(as.integer(length(list_raster_name)),unlist(list_raster_name))
  writeLines(dat_list,con=paste(out_suffix_s,".rgf",sep=""))
  
  #now write out stack...
  if(file_format==".tif"){
    raster_name<-paste("raster","_",row, "r_", col,"c_","ts_",k,"_",out_suffix,file_format, sep="")
    #writeRaster(r_comb, NAflag=NA_flag_val,filename=raster_name,bylayer=FALSE,bandorder="BSQ",overwrite=TRUE)
    writeRaster(r_temp, NAflag=NA_flag_val,filename=raster_name,bylayer=TRUE,bandorder="BSQ",overwrite=TRUE)   
  }
  return(r_temp)
}

#Add moving spatial pattern function here...
#...
#combine sine in x and y in small window
#Create sequence with position on a circle...(if 12, divide circle in 12 location)
#combine sequence with r stack with specific time event...
#generate_moving_space_time_structure <-function(rast_ref,rast_pattern="",temp_event,period,out_suffix,NA_flag_val,file_format,option="addition"){
generate_moving_space_time_structure <-function(list_param){
    
  sine_structure_fun <-function(x,T,phase,a,b){
    #Create sine for a one dimensional series
    #Note that sine function uses radian unit.
    #a=amplitude
    #b=mean or amplitude 0 of the series
    #T= stands for period definition
    #phase=phase angle (in radian!!)
    
    y <- a*sin((x*pi/T)+ phase) + b
  }
  
  ## Parse input arguments
  
  r_stack <- list_param$r_stack
  temp_period<-list_param$temp_period
  period <- list_param$period
  NA_flag_val <- list_param$NA_flag_val
  file_format <- list_param$file_format #".tif" or ".rst" for the time being
  #type_spatialstructure <- list_param$type_spatialstructure
  out_suffix <- list_param$out_suffix
  out_dir <-list_param$out_dir
  rast_pattern <- list_param$rast_pattern #moving spatial pattern provided
  #moving spatial pattern provided
  rast_ref <-subset(r_stack,1)
  row_ref <- nrow(rast_ref)  
  col_ref <- ncol(rast_ref)
  proj_str <- projection(rast_ref)
  
  ### Step 1: Generate default spatial pattern or used raster provided:  
  if(rast_pattern==""){
    row <- round(row_ref/2)
    col <- round(col_ref/2)
    
    pix_values <- rep(1,row*col)
    
    r<-raster(nrows=row, ncols=col,crs=proj_str,xmn=0, xmx = col, ymn=0, ymx=row)
    r <- setValues(r,pix_values)
    
    u <- xFromCol(r,colnr=1:col)
    a<- 2 #amplitude in this case
    b<- 0
    T<- round(col)
    phase <- 0  
    ux <- sine_structure_fun(u,T,phase,a,b)
    ux <-rep(ux,time=row)  
    r8 <-setValues(r,ux)  
    plot(r8)
    #Generate spatial pattern 9:  
    r9 <- t(r8)
    #Generate spatial pattern 10:  
    r10 <- r8 + r9
    levelplot(r10)
    #### end of generate spatial pattern  
  }else{
    r10<-rast_pattern
  }
  
  ##Step 2 generate spatial trajectory
  
  #Create unit circle
  T1 <- period
  x <-seq(-pi,pi,by=2*pi/360)
  x1<-sin(x)
  x2<-sin(x-pi/2)
  
  u1 <- sqrt(col_ref/2)*x1 + col_ref/2
  v1 <- sqrt(row_ref/2)*x2 + row_ref/2
  n<- 360/T1
  
  v1<-v1[ seq_along(v1) %% n == 0 ]
  u1<-u1[ seq_along(u1) %% n == 0 ]
  
  peak <- data.frame(z=rep(2,length(v1)))
  circle <- SpatialPointsDataFrame(coords=cbind(u1,v1),data=peak)
  #First put r10 at 0,0 (left botton corner) #This is already the case
  
  ## Step 3: generate sequence: if period>12 then it will spread over more than a year...
  extent_pat <- extent(r10)
  
  #Calculate projection parameters
  centroid_y_pat <- (ymax(extent_pat)- ymin(extent_pat))/2
  centroid_x_pat <- (xmax(extent_pat)- xmin(extent_pat))/2

  coords_locs<-coordinates(circle)
  coords_locs[,1] <- coords_locs[,1] - centroid_x_pat
  coords_locs[,2] <- coords_locs[,2] - centroid_y_pat

  #Now start sequences
  rast_seq <- vector("list",length=T1)
 
  T1 <- period
  if (A_seq==""){
    x <-seq(0,2*pi,by=2*pi/360)
    x1<-sin(x)
    n<- 360/T1
    A_seq <-x1[ seq_along(x1) %% n == 0 ]
  }
  #if A_seq provided use the sequence

  for (k in 1:T1){
    
    r10_shifted <- shift(r10,x=coords_locs[k,1],y=coords_locs[k,2])
    #plot(r10_shifted,add=T)
    spdf_shifted <- as(r10_shifted,"SpatialPointsDataFrame")
    r_seq <-rasterize(spdf_shifted,rast_ref,"layer")*A_seq[k]
    rast_seq[[k]] <-cover(r_seq,rast_ref)
  }
  #text(x=coords_locs[,1],y=coords_locs[,2],1:12)
  rast_seq <-stack(rast_seq)
  
  ## Step 4: Add sequence to the empty stack...
  
  #Now combine with r_stack with using timing of event
  for(k in 1:length(temp_event)){
    timing<-temp_event[k]
    for (i in 1:nlayers(rast_seq)){
      r_seq <- subset(rast_seq,i)
      r_stack <-setValues(r_stack,values(r_seq),timing-1+i) #choose layer from stack and set values...
    }
  }
  
  #now write out stack...
  #if(file_format==".tif"){
  #  raster_name<-paste("raster","_",row, "r_", col,"c_","ts_",k,"_",out_suffix,file_format, sep="")
  #  #writeRaster(r_comb, NAflag=NA_flag_val,filename=raster_name,bylayer=FALSE,bandorder="BSQ",overwrite=TRUE)
  #  writeRaster(r_temp, NAflag=NA_flag_val,filename=raster_name,bylayer=TRUE,bandorder="BSQ",overwrite=TRUE)   
  #}
  return(r_stack)
}

plot_time_space_pattern<-function(time_pattern,rast_spat,out_suffix){
  layout_m<-c(1,2) #one row two columns
  par(mfrow=layout_m)

  plot(temp_pattern,type="b")
  plot(rast_spat)
  
  png(paste("Figure__spatial_and_time_",out_suffix,".png", sep=""),
      height=480*layout_m[1],width=480*layout_m[2])
  
  plot(temp_pattern,type="b")
  plot(rast_spat)
  dev.off()
  
}

create_idrisi_rgf<-function(file_pat="",out_suffix_s,in_dir="."){
  #create a list of raster idrisi  files...
  if(file_pat==""){
    list_raster_name <- list.files(path=in_dir,pattern=paste(out_suffix_s,".*.rst$",sep=""),full.names=T)
  }else{
    list_raster_name <- list.files(path=in_dir,pattern=file_pat,full.names=T)
  }
  dat_list<-c(as.integer(length(list_raster_name)),mixedsort(unlist(list_raster_name)))
  filenames.noext = sub("[.][^.]*$", "", filenames.ext, perl=TRUE)) 
  
  writeLines(dat_list,con=paste(out_suffix_s,".rgf",sep=""))
}

##### Parameters and arguments #####

#in_dir<- "/Users/benoitparmentier/Dropbox/MEOT"
#out_dir <- "/Users/benoitparmentier/Dropbox/MEOT"

in_dir <- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/synthetic_dataset_MEOT_revisions"
out_dir<- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/synthetic_dataset_MEOT_revisions"
setwd(out_dir)

j <- 1 #number of images
col <- 12 
row <- 12
proj_str <- NA
range_val <- c(0,1)
distribution_val_i <-"none" #c("unif","norm","none") 
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
out_suffix <- "gen_08192013"

#temp_event <-c(13,49,85,121)
#period <- 12

#########################################################
#################### BEGIN SCRIPT ########################

##### PART I : Prepare input temporal and spatial patterns #####

#step 1: generate raster image/region

list_param_gen_raster<-list(j,col,row,proj_str,range_val,NA_flag_val,distribution_val_i,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i","out_suffix","out_dir")

r <- generate_raster_region(1,list_param_gen_raster)
plot(r)

#step 2: generate spatial structure

#note that r is the raste image!!
list_param_adding_spatial_structure <-list(j,r,proj_str,range_val,NA_flag_val,file_format,out_suffix, out_dir)
names(list_param_adding_spatial_structure)<-c("j","r","proj_str","range_val","NA_flag_val","file_format","out_suffix","out_dir")

r_spat_s <-adding_sptatial_structure(1,list_param_adding_spatial_structure)
plot(r_spat_s) #examine available pattern

#Generate moving structure?
#Add separate function for this...? yes...coming soon

#Step 3: generate temporal structure

#Also add option for temp_index

nt <- 312 #month units conventially
#temp_index <-""...
temp_periods <- c(12) #
temp_periods <- c(156,78,39,12)
temp_period_quadrature <- c(12)
phase<-pi/2

list_param_adding_temp_str <- list(nt,temp_periods,temp_period_quadrature,phase)
names(list_param_adding_temp_str) <- list("nt","temp_periods","temp_period_quadrature","phase")

#debug(adding_temporal_structure)
temp_pattern_dfrm <- adding_temporal_structure(list_param_adding_temp_str)
plot.ts(temp_pattern_dfrm) #visualize quickly all available time patterns
y<- temp_pattern_dfrm$t_period_12
plot(y,type="b")
abline(h=0, v=0, col = "gray60")

temp_pattern <- as.numeric(2*y)

#Replicate same image n times into a stack

r <- subset(r_spat_s,"constant")-1 #base image is at zero...
r_stack <- generate_stack_raster(r,nt)

###############################
######## PART II : Generate space-time datasets using input temporal and spatial patterns =
#NOW create a few datasets for the MEOT and MSSA/PCA diagnostics...

#there will be 8 datasets...

list_temp_pattern_produced <- vector("list",length=8)

##################
###### Create first test dataset:
ts1<-temp_pattern_dfrm$t_period_156 #1 full cyle
ts2<-temp_pattern_dfrm$t_period_12 #12 months periods...25 cycles
ts3<-temp_pattern_dfrm$trend #linear  trend  of slope 1

temp_pattern <- 2*ts2 
plot(temp_pattern,type="b")

#Prepare spatial pattern, choose from r_spat_s
r<-1*subset(r_spat_s,"constant") -1
r_stack<-generate_stack_raster(r,nt)
  
#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts1_",out_suffix,sep="")
plot_time_space_pattern(temp_pattern,r,out_suffix_s)
operation="addition"
#debug(combine_space_time_structure)
r_ts1 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format,operation)

levelplot(r_ts1,layers=c(1,78,156,234,312))
levelplot(r_ts1,layers=1:24)
plot((subset(r_ts1,1:24)))

list_temp_pattern_produced[[1]] <- temp_pattern
names(list_temp_pattern_produced)[1] <- out_suffix_s

#####################
##### Create second test dataset:

#Prepare temporal pattern
ts1<-temp_pattern_dfrm$t_period_156 #1 full cyle
ts2<-temp_pattern_dfrm$t_period_12 #12 months periods...25 cycles
ts3<-temp_pattern_dfrm$trend #linear  trend  of slope 1
temp_pattern <- 2*ts1 + 2*ts2 
plot(temp_pattern,type="b")

#Prepare spatial pattern
r<-1*subset(r_spat_s,"constant_sqr") 
r_stack<-generate_stack_raster(r,nt)

#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts2_",out_suffix,sep="")
operation="addition"
r_ts2 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format,operation)
plot_time_space_pattern(temp_pattern,r,out_suffix_s)
list_temp_pattern_produced[[2]] <- temp_pattern
names(list_temp_pattern_produced)[2] <- out_suffix_s

#Checking the raster time series generated:
levelplot((subset(r_ts2,c(1,78,156,234,312))))
levelplot(subset(r_ts2,c(1,178)))
levelplot(r_ts2,layers=1:24)
plot((subset(r_ts2,1:24)))

list_temp_pattern_produced[[2]] <- temp_pattern
names(list_temp_pattern_produced)[2] <- out_suffix_s

########################################
##### Create third test dataset:

#Prepare temporal pattern
ts1<-temp_pattern_dfrm$t_period_156 #1 full cyle
ts2<-temp_pattern_dfrm$t_period_12 #12 months periods...25 cycles
temp_pattern <- 3*ts1 + 3*ts2
plot(temp_pattern,type="b")

#Prepare spatial pattern
r<-1*subset(r_spat_s,"periodic_xy2")
r_stack<-generate_stack_raster(r,nt) #Can be modified for efficiency, save to ".tif"

#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts3_",out_suffix,sep="")
r_ts3 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format,operation)
  
levelplot((subset(r_ts3,c(1,78,156,234,312))))
levelplot(r_ts3,layers=1:24)
list_temp_pattern_produced[[3]] <- temp_pattern
names(list_temp_pattern_produced)[3] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

#######################################
##### Create fourth test dataset:

#Use periodic spatial pattern
#Prepare temporal pattern
ts1<-temp_pattern_dfrm$t_period_156 #1 full cyle
ts2<-temp_pattern_dfrm$t_period_12 #12 months periods...25 cycles
ts4<- temp_pattern_dfrm$norm #random normal pattern
temp_pattern <- 3*ts1 + 3*ts2 + 1*ts4
plot(temp_pattern,type="b")

#Prepare spatial pattern
r<-1*subset(r_spat_s,"periodic_xy3") # can combine basic spatial structures!!
r_stack<-generate_stack_raster(r,nt)

#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts4_",out_suffix,sep="")
r_ts4 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format,operation)

levelplot(r_ts4,layers=c(1,78,156,234,312))
levelplot(r_ts4,layers=c(1,178))
list_temp_pattern_produced[[4]] <- temp_pattern
names(list_temp_pattern_produced)[4] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

######################################
##### Create fifth test dataset:

#Use moving spatial pattern

### Create rgf for IDRISI to speed up the building of time series...

#out_suffix_s <- paste("r_ts4_",out_suffix,sep="")
#list.files(pattern=paste(".*.",out_suffix,sep=""),full.names=TRUE)
temp_event <-c(13,49,85,121)
period <- 12
rast_pattern=""

#Prepare spatial pattern
r<-1*subset(r_spat_s,"constant") -1 # can combine basic spatial structures!!
r_stack<-generate_stack_raster(r,nt)

list_param_gen_moving_pat <-list(r_stack,rast_pattern,temp_event,period,
                                 out_suffix, out_dir,NA_flag_val,file_format)
names(list_param_gen_moving_pat) <-c("r_stack","rast_pattern","temp_event","period",
                                 "out_suffix", "out_dir","NA_flag_val","file_format")
debug(generate_moving_space_time_structure)
r_stack <- generate_moving_space_time_structure(list_param_gen_moving_pat)

levelplot(r_stack,layers=1:48)
#ts1<-temp_pattern_dfrm$periodic$t_period_156 #1 full cyle
ts2<-temp_pattern_dfrm$periodic$t_period_12 #12 months periods...25 cycles
#ts4<- temp_pattern_dfrm$norm #random normal pattern
temp_pattern <- 1*rep(1,length=nt) 
plot(temp_pattern,type="b")

#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts5_",out_suffix,sep="")
operation="multiplication"
#debug(combine_space_time_structure)
r_ts5 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format,operation)

levelplot(r_ts5,layers=c(1,78,156,234,312))
levelplot(r_ts5,layers=c(1,178))
list_temp_pattern_produced[[5]] <- temp_pattern
names(list_temp_pattern_produced)[5] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

######################################
##### Create sixth test dataset:

#Use moving spatial pattern

### Create rgf for IDRISI to speed up the building of time series...

#out_suffix_s <- paste("r_ts4_",out_suffix,sep="")
#list.files(pattern=paste(".*.",out_suffix,sep=""),full.names=TRUE)
temp_event <-c(13,49,85,121)
period <- 24
rast_pattern=""

#Prepare spatial pattern
r<-1*subset(r_spat_s,"constant") -1 # can combine basic spatial structures!!
r_stack<-generate_stack_raster(r,nt)

list_param_gen_moving_pat <-list(r_stack,rast_pattern,temp_event,period,
                                 out_suffix, out_dir,NA_flag_val,file_format)
names(list_param_gen_moving_pat) <-c("r_stack","rast_pattern","temp_event","period",
                                     "out_suffix", "out_dir","NA_flag_val","file_format")

r_stack <- generate_moving_space_time_structure(list_param_gen_moving_pat)

temp_pattern <- 1*rep(1,length=nt) 
plot(temp_pattern,type="b")

plot(temp_pattern,type="b")

#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts6_",out_suffix,sep="")
operation<-"multiplication"
r_ts6 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format,operation)

levelplot(r_ts6,layers=c(1,78,156,234,312))
levelplot(r_ts6,layers=c(1,178))
levelplot(r_ts6,layers=1:48)

list_temp_pattern_produced[[6]] <- temp_pattern
names(list_temp_pattern_produced)[6] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

######################################
##### Create seventh test dataset:

#Use moving spatial pattern

### Create rgf for IDRISI to speed up the building of time series...

#out_suffix_s <- paste("r_ts4_",out_suffix,sep="")
#list.files(pattern=paste(".*.",out_suffix,sep=""),full.names=TRUE)
temp_event <-c(13,49,85,121)
period <- 24
rast_pattern=""

#Prepare spatial pattern
r<-1*subset(r_spat_s,"constant") # can combine basic spatial structures!!
r_stack<-generate_stack_raster(r,nt)

list_param_gen_moving_pat <-list(r_stack,rast_pattern,temp_event,period,
                                 out_suffix, out_dir,NA_flag_val,file_format)

r_stack <- generate_moving_space_time_structure(list_param_gen_moving_pat)

#ts1<-temp_pattern_dfrm$periodic$t_period_156 #1 full cyle
ts2<-temp_pattern_dfrm$periodic$t_period_12 #12 months periods...25 cycles
#ts4<- temp_pattern_dfrm$norm #random normal pattern
temp_pattern <- 2*ts2 
plot(temp_pattern,type="b")

#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts6_",out_suffix,sep="")
r_ts6 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format)

list_temp_pattern_produced[[7]] <- temp_pattern
names(list_temp_pattern_produced)[7] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

######################################
##### Create eigth test dataset:

#Use moving spatial pattern

T1 <- period
x <-seq(0,2*pi,by=2*pi/(360*2))
x1<-sin(x)
n<- 360/T1
A_seq <-x1[ seq_along(x1) %% n == 0 ]
plot(A_seq)
#if A_seq provided use the sequence

#out_suffix_s <- paste("r_ts4_",out_suffix,sep="")
#list.files(pattern=paste(".*.",out_suffix,sep=""),full.names=TRUE)
temp_event <-c(13,61,109,157)
period <- 36
rast_pattern=""

#Prepare spatial pattern
r<-1*subset(r_spat_s,"constant") # can combine basic spatial structures!!
r_stack<-generate_stack_raster(r,nt)

list_param_gen_moving_pat <-list(r_stack,rast_pattern,temp_event,period,
                                 out_suffix, out_dir,NA_flag_val,file_format)

r_stack <- generate_moving_space_time_structure(list_param_gen_moving_pat)

temp_pattern <- 1*rep(1,length=nt) 
plot(temp_pattern,type="b")

#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts8_",out_suffix,sep="")
r_ts8 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format)

list_temp_pattern_produced[[8]] <- temp_pattern
names(list_temp_pattern_produced)[8] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

######################################
##### Create nineth test dataset:

#Use moving spatial pattern

T1 <- period
x <-seq(0,2*pi,by=2*pi/(360*2))
x1<-sin(x)
n<- 360/T1
A_seq <-x1[ seq_along(x1) %% n == 0 ]
plot(A_seq)
#if A_seq provided use the sequence

#out_suffix_s <- paste("r_ts4_",out_suffix,sep="")
#list.files(pattern=paste(".*.",out_suffix,sep=""),full.names=TRUE)
temp_event <-c(13,61,109,157)
period <- 48
rast_pattern=""

#Prepare spatial pattern
r<-1*subset(r_spat_s,"constant") # can combine basic spatial structures!!
r_stack<-generate_stack_raster(r,nt)

list_param_gen_moving_pat <-list(r_stack,rast_pattern,temp_event,period,
                                 out_suffix, out_dir,NA_flag_val,file_format)

r_stack <- generate_moving_space_time_structure(list_param_gen_moving_pat)

temp_pattern <- 1*rep(1,length=nt) 
plot(temp_pattern,type="b")

#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts9_",out_suffix,sep="")
r_ts9 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format)

list_temp_pattern_produced[[9]] <- temp_pattern
names(list_temp_pattern_produced)[9] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

######################################
##### Create test dataset 10:

#Use moving spatial pattern

T1 <- period
x <-seq(0,2*pi,by=2*pi/(360*2))
x1<-sin(x)
n<- 360/T1
A_seq <-x1[ seq_along(x1) %% n == 0 ]
plot(A_seq)
#if A_seq provided use the sequence

#out_suffix_s <- paste("r_ts4_",out_suffix,sep="")
#list.files(pattern=paste(".*.",out_suffix,sep=""),full.names=TRUE)
temp_event <-c(13,61,109,157)
period <- 72
rast_pattern=""

#Prepare spatial pattern
r<-1*subset(r_spat_s,"constant") # can combine basic spatial structures!!
r_stack<-generate_stack_raster(r,nt)

list_param_gen_moving_pat <-list(r_stack,rast_pattern,temp_event,period,
                                 out_suffix, out_dir,NA_flag_val,file_format)

r_stack <- generate_moving_space_time_structure(list_param_gen_moving_pat)

temp_pattern <- 1*rep(1,length=nt) 
plot(temp_pattern,type="b")

#Prepare to generate images combining time and space
out_suffix_s <- paste("r_ts10_",out_suffix,sep="")
r_ts10 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format)

list_temp_pattern_produced[[10]] <- temp_pattern
names(list_temp_pattern_produced)[10] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

########## END OF SCRIPT ##############