########################################       Generation of space-time dataset       #######################################
########################################### For Testing MSSA-MEOT and S-T mode PCA #####################################
#This script generates synthetic space time dataset in R to test EOT,MEOT,PCA and MSSA.
#Output format can be chosen between IDRISI raster and tif.
#Space-time series can be generated by combining a set of spatial patterns and temporal patterns. 
#This script uses 11 functions stored in a separate file: generation_of_space_time_dataset_functions_09042013v5.R.
#AUTHORS:Benoit Parmentier                                             
#DATE: 11/15/2013                                                                                
#PROJECT: Clark Labs, MEOT, time series             
#TO DO:
#Write trajectory function...
###################################################################################################

###Loading R library and packages                                                      

library(gtools)   # loading various useful tools such as mixedsort 
library(sp)        #Spatial object models and functionality
library(raster)    #Raster functionality
library(rasterVis) #Raster visualization
library(rgdal)     #GDAL binding
library(vegan) 
library(parallel)   # parallelization based on snow
library(mgcv)                                # GAM package by Simon Wood
library(spdep)                               # Spatial pacakge with methods and spatial stat. by Bivand et al.
library(gstat)                               # Kriging and co-kriging by Pebesma et al.
library(fields)                              # NCAR Spatial Interpolation methods such as kriging, splines
library(foreign)                             # Library for format exchange (e.g. dbf,spss,sas etc.)
library(gdata)                               # various tools with xls reading
library(xts)                                 # basic package for time series analysis
library(zoo)                                 # basic package for time series analysis
library(forecast)                            # package containing ARIMA procedures
library(plotrix)
library(matrixStats) 

##### Functions used in this script #####

functions_generation_space_time_datasets <- "generation_of_space_time_dataset_functions_11152013v6.R"

script_path<-"/Users/benoitparmentier/Dropbox/Data/MEOT_paper/" #path to script
source(file.path(script_path,functions_generation_space_time_datasets)) #source all functions used in this script.

############# Parameters and arguments ####################

#in_dir<- "/Users/benoitparmentier/Dropbox/MEOT"
#out_dir <- "/Users/benoitparmentier/Dropbox/MEOT"

in_dir <- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/MEOT12272012/3x3dataset"
out_dir<- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/"

if (!file.exists(out_dir)){
  dir.create(out_dir)
  #} else{
  #  out_path <-paste(out_path..)
}
setwd(out_dir)

j <- 45 #number of images
col <- 3 # number of columns in the images 
row <- 3 # number of rows in the images

proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"none" #c("unif","norm","none") 
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
out_suffix <- "gen_11152013"

#########################################################
#################### BEGIN SCRIPT ########################

##### PART I : Prepare input temporal and spatial patterns #####

#step 1: generate raster image/region

list_param_gen_raster<-list(j,col,row,proj_str,range_val,NA_flag_val,distribution_val_i,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i","out_suffix","out_dir")

r <- generate_raster_region(1,list_param_gen_raster)
plot(r)

j <- 45 #number of images
col <- 3 # number of columns in the images 
row <- 3 # number of rows in the images

proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"none" #c("unif","norm","none") 
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
out_suffix <- "gen_11152013"

#step 2: generate spatial structure

#note that r is the raste image!!
list_param_adding_spatial_structure <-list(j,r,proj_str,range_val,NA_flag_val,file_format,out_suffix, out_dir)
names(list_param_adding_spatial_structure)<-c("j","r","proj_str","range_val","NA_flag_val","file_format","out_suffix","out_dir")

r_spat_s <-adding_sptatial_structure(1,list_param_adding_spatial_structure)
plot(r_spat_s) #examine available pattern

#Generate moving structure?
#Add separate function for this...? yes...coming soon

#Step 3: generate temporal structure

#Also add option for temp_index

nt <- 45 #month units conventially
#temp_index <-""...
temp_periods <- c(12) #
temp_periods <- c(156,78,39,12)
temp_period_quadrature <- c(12)
phase<-pi/2

list_param_adding_temp_str <- list(nt,temp_periods,temp_period_quadrature,phase)
names(list_param_adding_temp_str) <- list("nt","temp_periods","temp_period_quadrature","phase")

#debug(adding_temporal_structure)
temp_pattern_dfrm <- adding_temporal_structure(list_param_adding_temp_str)
plot.ts(temp_pattern_dfrm) #visualize quickly all available time patterns
y<- temp_pattern_dfrm$t_period_12
plot(y,type="b")
abline(h=0, v=0, col = "gray60")

temp_pattern <- as.numeric(2*y)

#Replicate same image n times into a stack

r <- subset(r_spat_s,"constant")-1 #base image is at zero...
r_stack <- generate_stack_raster(r,nt)

#######################################################
######## PART II : Generate space-time datasets using input temporal and spatial patterns =
#NOW create a few datasets for the MEOT and MSSA/PCA diagnostics...

#there are currently 10 datasets generated...

list_temp_pattern_produced <- vector("list",length=3)
#quartz(13,8)

##################
###### Create first test dataset:
#ts1<-temp_pattern_dfrm$t_period_156 #1 full cyle
#ts2<-temp_pattern_dfrm$t_period_12 #12 months periods...25 cycles Needs to be changed this is 24 months!!!
#ts3<-temp_pattern_dfrm$trend #linear  trend  of slope 1

######################################
##### Create nb 1 test dataset: standing pattern on the west end  of the image with period 12

#Use moving spatial pattern: standing pattern

#Create seq full 
temp_event <-c(1,10,19,28,37) #timing of event
period <- 9
rast_pattern=NULL #image is provided later...

x<-1:period
period#period
phase<-0
a<-1 #amplitude
b<-0
x
A_seq <-rep(4,period) #different weight with negative!!!
plot(A_seq)
#if A_seq provided use the sequence

#Prepare spatial pattern
r <- 1*subset(r_spat_s,"constant") -1 # can combine basic spatial structures!!
r_stack<-generate_stack_raster(r,nt) #this replicates the same image

#debug(generate_spatial_trajectory) #note that the trajectory period is set earlier!!!
trajectory_list <- generate_spatial_trajectory(r,period)
trajectory <- trajectory_list$circle
#trajectory <- NULL
trajectory <- trajectory_list$s_ne

plot(r)
plot(trajectory,add=T)
text(coordinates(trajectory),labels=trajectory$layer)

##Raster pattern
proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"none" #c("unif","norm","none") 
sd_val<-1
mean_val<-0

list_param_gen_raster<-list(1,1,1,proj_str,range_val,NA_flag_val,distribution_val_i,
                            sd_val,mean_val,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i",
                                "sd_val","mean_val","out_suffix","out_dir")

rast_pattern <- generate_raster_region(1,list_param_gen_raster)

list_param_gen_moving_pat <-list(r_stack,rast_pattern,temp_event,period,trajectory,
                                 out_suffix, out_dir,NA_flag_val,file_format,A_seq)
names(list_param_gen_moving_pat) <-c("r_stack","rast_pattern","temp_event","period","trajectory",
                                     "out_suffix", "out_dir","NA_flag_val","file_format","A_seq")

#undebug(generate_moving_space_time_structure)
moving_ST_struct_obj <- generate_moving_space_time_structure(list_param_gen_moving_pat)
r_stack<-moving_ST_struct_obj$r_stack
rast_seq <-moving_ST_struct_obj$rast_seq
trajectory <- moving_ST_struct_obj$trajectory
temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
levelplot(r_stack,layers=1:45, col.regions=temp.colors)

plot(A_seq)
levelplot(rast_seq,layers=1:period,col.regions=temp.colors)

#Now generate random images to add to the sequence...

j <- 45 #number of images
col <- 3 # number of columns in the images 
row <- 3 # number of rows in the images

proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"norm" #c("unif","norm","none")
sd_val<-0.001
mean_val<-0
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
out_suffix <- "gen_10162013"

list_param_gen_raster<-list(j,col,row,proj_str,range_val,NA_flag_val,distribution_val_i,
                            mean_val,sd_val,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i",
                                "mean_val","sd_val","out_suffix","out_dir")

r_random_s <- stack(lapply(1:nt,FUN=generate_raster_region,list_param=list_param_gen_raster))
levelplot(r_random_s,layers=1:45,col.regions=temp.colors)

#Combine both moving pattern and randomness
r_stack_comb <-r_stack + r_random_s

temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
levelplot(r_stack_comb,layers=1:nt, col.regions=temp.colors)

#ts1<-temp_pattern_dfrm$periodic$t_period_156 #1 full cyle
#ts2<-temp_pattern_dfrm$periodic$t_period_12 #12 months periods...25 cycles
#ts4<- temp_pattern_dfrm$norm #random normal pattern
temp_pattern <- 1*rep(1,length=nt) 
plot(temp_pattern,type="b")

#Prepare to generate images combining time and space
out_suffix_s <- paste("r1_test3x3_",out_suffix,sep="")
operation="multiplication"
#undebug(combine_space_time_structure)
#This is output without random component...
r1_test3x3 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format,out_dir,operation)
#This is output  with random component...
out_suffix_s <- paste("r1r_test3x3_",out_suffix,sep="")
operation="multiplication"

r1r_test3x3 <- combine_space_time_structure(temp_pattern,r_stack_comb,out_suffix_s,NA_flag_val,file_format,out_dir,operation)

list_temp_pattern_produced[[1]] <- temp_pattern
names(list_temp_pattern_produced)[1] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

#example for one series:
out_suffix_s <- paste("r1_test3x3_",out_suffix,sep="")
out_prefix_str <- "test_3c_3r_"
list_r1 <- mixedsort(create_idrisi_rgf(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix=out_prefix_str))

out_suffix_s <- paste("r1r_test3x3_",out_suffix,sep="")
out_prefix_str <- "test_3c_3r_"
list_r1r <- mixedsort(create_idrisi_rgf(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix=out_prefix_str))

#############################################################
##### Create second test dataset: random signal + 5 sequences with cosine signal

#Replicate same image n times into a stack

r <- subset(r_spat_s,"constant")-1 #base image is at zero...
r_stack <- generate_stack_raster(r,nt)

trajectory <- trajectory_list$s_ne

trajectory_list <- generate_spatial_trajectory(r,period)
trajectory <- trajectory_list$s_ne
plot(r)
plot(trajectory,add=T)
text(coordinates(trajectory),labels=trajectory$layer)

##Raster pattern
proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"none" #c("unif","norm","none") 
sd_val<-1
mean_val<-0

list_param_gen_raster<-list(1,1,1,proj_str,range_val,NA_flag_val,distribution_val_i,
                            sd_val,mean_val,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i",
                                "sd_val","mean_val","out_suffix","out_dir")

rast_pattern <- generate_raster_region(1,list_param_gen_raster)

## Phase in the window
x<-1:period
period#period
phase<-pi/2
a<-1 #amplitude
b<-0
x
A_seq <- rev(sine_structure_fun(1:period,period/2,phase,a,b)) #different weight with negative!!!
plot((A_seq))

list_param_gen_moving_pat <-list(r_stack,rast_pattern,temp_event,period,trajectory,
                                 out_suffix, out_dir,NA_flag_val,file_format,A_seq)
names(list_param_gen_moving_pat) <-c("r_stack","rast_pattern","temp_event","period","trajectory",
                                     "out_suffix", "out_dir","NA_flag_val","file_format","A_seq")

#undebug(generate_moving_space_time_structure)
moving_ST_struct_obj <- generate_moving_space_time_structure(list_param_gen_moving_pat)
r_stack<-moving_ST_struct_obj$r_stack
rast_seq <-moving_ST_struct_obj$rast_seq
trajectory <- moving_ST_struct_obj$trajectory
temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
levelplot(r_stack,layers=1:45, col.regions=temp.colors)

plot(A_seq)
levelplot(rast_seq,layers=1:period,col.regions=temp.colors)

#Now generate random images to add to the sequence...

j <- 45 #number of images
col <- 3 # number of columns in the images 
row <- 3 # number of rows in the images

proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"norm" #c("unif","norm","none")
sd_val<-0.001
mean_val<-0
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
out_suffix <- "gen_10162013"

list_param_gen_raster<-list(j,col,row,proj_str,range_val,NA_flag_val,distribution_val_i,
                            mean_val,sd_val,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i",
                                "mean_val","sd_val","out_suffix","out_dir")

r_random_s <- stack(lapply(1:nt,FUN=generate_raster_region,list_param=list_param_gen_raster))
#Parallel processes if cores are changed to greater than 1 (MacOS and Linux/Unix only)
#r_random_s <- stack(mclapply(1:nt, list_param=list_param_gen_raster, FUN=generate_raster_region, 
#              mc.preschedule=FALSE,mc.cores = 1)) #This is the end bracket from mclapply(...) statement

levelplot(r_random_s,layers=1:45,col.regions=temp.colors)

#Combine both moving pattern and randomness
r_stack_comb <-r_stack + r_random_s

temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
levelplot(r_stack_comb,layers=1:nt, col.regions=temp.colors)

#ts1<-temp_pattern_dfrm$periodic$t_period_156 #1 full cyle
#ts2<-temp_pattern_dfrm$periodic$t_period_12 #12 months periods...25 cycles
#ts4<- temp_pattern_dfrm$norm #random normal pattern
temp_pattern <- 1*rep(1,length=nt) 
plot(temp_pattern,type="b")

#Prepare to generate images combining time and space

#undebug(combine_space_time_structure)
#need to modify for parallelization process and change for efficiency later 
#This is output without random component...
out_suffix_s <- paste("r2_test3x3_",out_suffix,sep="")
operation="multiplication"
r2_test3x3 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format,out_dir,operation)

#This is output with random component...
out_suffix_s <- paste("r2r_test3x3_",out_suffix,sep="")
operation="multiplication"

r2r_test3x3 <- combine_space_time_structure(temp_pattern,r_stack_comb,out_suffix_s,NA_flag_val,file_format,out_dir,operation)

list_temp_pattern_produced[[2]] <- temp_pattern
names(list_temp_pattern_produced)[2] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

#example for one series:

out_suffix_s <- paste("r2_test3x3_",out_suffix,sep="")
out_prefix_str <- "test_3c_3r_"
list_r2 <- mixedsort(create_idrisi_rgf(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix=out_prefix_str))
#ist_r_ts <- create_raster_list_from_file_pat(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix="",file_format=".rst")

out_suffix_s <- paste("r2r_test3x3_",out_suffix,sep="")
out_prefix_str <- "test_3c_3r_"
list_r2r <- mixedsort(create_idrisi_rgf(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix=out_prefix_str))

#Change to zip files in R rather than Linux/MacOs/Unix, use zip from zip Utils R works 
#accross platforms (i.e. Windows)
#system("zip -r r1r_test3x3_gen_10162013.zip r1r_test3x3_gen_10162013")
#system("zip -r r2r_test3x3_gen_10162013.zip r2r_test3x3_gen_10162013")
#system("zip -r r1_test3x3_gen_10162013.zip r1_test3x3_gen_10162013")
#system("zip -r r2_test3x3_gen_10162013.zip r2_test3x3_gen_10162013")

############################# PART III #################
#### CREATE ONE SERIES 9x9 #####

#step 1: generate raster image/region

j <- 45 #number of images
col <- 9 # number of columns in the images 
row <- 9 # number of rows in the images

proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"none" #c("unif","norm","none") 
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
out_suffix <- "gen_10162013"

list_param_gen_raster<-list(j,col,row,proj_str,range_val,NA_flag_val,distribution_val_i,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i","out_suffix","out_dir")

r <- generate_raster_region(1,list_param_gen_raster)
plot(r)

#step 2: generate spatial structure

#note that r is the raste image!!
list_param_adding_spatial_structure <-list(j,r,proj_str,range_val,NA_flag_val,file_format,out_suffix, out_dir)
names(list_param_adding_spatial_structure)<-c("j","r","proj_str","range_val","NA_flag_val","file_format","out_suffix","out_dir")

r_spat_s <-adding_sptatial_structure(1,list_param_adding_spatial_structure)
plot(r_spat_s) #examine available pattern

#Generate moving structure?
#Add separate function for this...? yes...coming soon

nt <- 45 #month units conventially
#temp_index <-""...
temp_periods <- c(12) #
temp_periods <- c(156,78,39,12)
temp_period_quadrature <- c(12)
phase<-pi/2

list_param_adding_temp_str <- list(nt,temp_periods,temp_period_quadrature,phase)
names(list_param_adding_temp_str) <- list("nt","temp_periods","temp_period_quadrature","phase")

#debug(adding_temporal_structure)
temp_pattern_dfrm <- adding_temporal_structure(list_param_adding_temp_str)
plot.ts(temp_pattern_dfrm) #visualize quickly all available time patterns
y<- temp_pattern_dfrm$t_period_12
plot(y,type="b")
abline(h=0, v=0, col = "gray60")

temp_pattern <- as.numeric(2*y)

#Replicate same image n times into a stack

r <- subset(r_spat_s,"constant")-1 #base image is at zero...
r_stack <- generate_stack_raster(r,nt)


######################################
##### Create nb 1 test dataset: standing pattern on the west end  of the image with period 12

#Use moving spatial pattern: standing pattern

#Create seq full 
temp_event <-c(1,10,19,28,37) #timing of event
period <- 9
rast_pattern=NULL #image is provided later...

x<-1:period
period#period
phase<-0
a<-1 #amplitude
b<-0
x
A_seq <-rep(4,period) #different weight with negative!!!
plot(A_seq)
#if A_seq provided use the sequence

#Prepare spatial pattern
r <- 1*subset(r_spat_s,"constant") -1 # can combine basic spatial structures!!
r_stack<-generate_stack_raster(r,nt) #this replicates the same image

aggregate_opt <- 3 #use aggregate for s-shape trajectory
#debug(generate_spatial_trajectory) #note that the trajectory period is set earlier!!!
trajectory_list <- generate_spatial_trajectory(r,period,aggregate_opt)
trajectory <- trajectory_list$circle
#trajectory <- NULL
trajectory <- trajectory_list$s_ne

plot(r)
plot(trajectory,add=T)
text(coordinates(trajectory),labels=trajectory$layer)

##Raster pattern
proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"none" #c("unif","norm","none") 
sd_val<-1
mean_val<-0

list_param_gen_raster<-list(1,3,3,proj_str,range_val,NA_flag_val,distribution_val_i,
                            sd_val,mean_val,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i",
                                "sd_val","mean_val","out_suffix","out_dir")

rast_pattern <- generate_raster_region(1,list_param_gen_raster)

#note that r is the raste image!!
list_param_adding_spatial_structure <-list(j,rast_pattern,proj_str,range_val,NA_flag_val,file_format,out_suffix, out_dir)
names(list_param_adding_spatial_structure)<-c("j","r","proj_str","range_val","NA_flag_val","file_format","out_suffix","out_dir")

r_spat_s <-adding_sptatial_structure(1,list_param_adding_spatial_structure)
plot(r_spat_s) #examine available pattern

#Replicate same image n times into a stack

rast_pattern <- subset(r_spat_s,"periodic_xy1") #base image is at zero...
#r_stack <- generate_stack_raster(r,nt)

list_param_gen_moving_pat <-list(r_stack,rast_pattern,temp_event,period,trajectory,
                                 out_suffix, out_dir,NA_flag_val,file_format,A_seq)
names(list_param_gen_moving_pat) <-c("r_stack","rast_pattern","temp_event","period","trajectory",
                                     "out_suffix", "out_dir","NA_flag_val","file_format","A_seq")

#undebug(generate_moving_space_time_structure)
moving_ST_struct_obj <- generate_moving_space_time_structure(list_param_gen_moving_pat)
r_stack<-moving_ST_struct_obj$r_stack
rast_seq <-moving_ST_struct_obj$rast_seq
trajectory <- moving_ST_struct_obj$trajectory
temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
levelplot(r_stack,layers=1:45, col.regions=temp.colors)

plot(A_seq)
levelplot(rast_seq,layers=1:period,col.regions=temp.colors)

#Now generate random images to add to the sequence...

j <- 45 #number of images
col <- 9 # number of columns in the images 
row <- 9 # number of rows in the images

proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"norm" #c("unif","norm","none")
sd_val<-0.001
mean_val<-0
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
out_suffix <- "gen_10162013"

list_param_gen_raster<-list(j,col,row,proj_str,range_val,NA_flag_val,distribution_val_i,
                            mean_val,sd_val,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i",
                                "mean_val","sd_val","out_suffix","out_dir")

r_random_s <- stack(lapply(1:nt,FUN=generate_raster_region,list_param=list_param_gen_raster))
levelplot(r_random_s,layers=1:45,col.regions=temp.colors)

#Combine both moving pattern and randomness
r_stack_comb <-r_stack + r_random_s

temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
levelplot(r_stack_comb,layers=1:nt, col.regions=temp.colors)

temp_pattern <- 1*rep(1,length=nt) 
plot(temp_pattern,type="b")

#Prepare to generate images combining time and space

#undebug(combine_space_time_structure)
#need to modify for parallelization process and change for efficiency later 
#This is output without random component...
out_suffix_s <- paste("r3_test9x9_",out_suffix,sep="")
operation="multiplication"
r3_test9x9 <- combine_space_time_structure(temp_pattern,r_stack,out_suffix_s,NA_flag_val,file_format,out_dir,operation)

#This is output with random component...
out_suffix_s <- paste("r3r_test9x9_",out_suffix,sep="")
operation="multiplication"

r3r_test9x9 <- combine_space_time_structure(temp_pattern,r_stack_comb,out_suffix_s,NA_flag_val,file_format,out_dir,operation)

list_temp_pattern_produced[[3]] <- temp_pattern
names(list_temp_pattern_produced)[3] <- out_suffix_s
plot_time_space_pattern(temp_pattern,r,out_suffix_s)

#example for one series:

out_suffix_s <- paste("r3_test9x9_",out_suffix,sep="")
out_prefix_str <- "test_9c_9r_"
list_r3 <- mixedsort(create_idrisi_rgf(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix=out_prefix_str))
#ist_r_ts <- create_raster_list_from_file_pat(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix="",file_format=".rst")

out_suffix_s <- paste("r3r_test9x9_",out_suffix,sep="")
out_prefix_str <- "test_3c_3r_"
list_r3r <- mixedsort(create_idrisi_rgf(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix=out_prefix_str))

#Change to zip files in R rather than Linux/MacOs/Unix, use zip from zip Utils R works 
#accross platforms (i.e. Windows)
system("zip -r r3r_test9x9_gen_10162013.zip r1r_test3x3_gen_10162013")
system("zip -r r3_test9x9_gen_10162013.zip r2r_test3x3_gen_10162013")
#system("zip -r r1_test3x3_gen_10162013.zip r1_test3x3_gen_10162013")
#system("zip -r r2_test3x3_gen_10162013.zip r2_test3x3_gen_10162013")

### Simulate red noise: DATASET 1

#step 1: generate raster image/region

#Now generate random images to add to the sequence...

j <- 45 #number of images
col <- 3 # number of columns in the images 
row <- 3 # number of rows in the images

proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"norm" #c("unif","norm","none")
sd_val<- 1
mean_val<-0
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
#out_suffix <- "gen_10162013"

list_param_gen_raster<-list(j,col,row,proj_str,range_val,NA_flag_val,distribution_val_i,
                            mean_val,sd_val,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i",
                                "mean_val","sd_val","out_suffix","out_dir")
random_r <- generate_raster_region(1,list_param_gen_raster)
plot(random_r) #random spatial image which is the start of the red noise time series.

#generate red noise for every pixels...this should be  modified for large images...

t0_val <- 2
ar1_coef <- 0.9294 #AR1 for MEOT1
nt<-45
temp_test <- gen_ar1_ts_fun(t0_val,ar1_coef,nt)
t0_val <- 1
temp_test2 <- gen_ar1_ts_fun(t0_val,ar1_coef,nt)

temp_rednoise_s <- lapply(values(random_r),FUN=gen_ar1_ts_fun ,ar1_coef=ar1_coef,nt=45,sd_rd=1,mean_rd=0)

plot(temp_rednoise_s[[1]],type="b",col="blue")
lines(temp_rednoise_s[[2]],type="b", col="red")
mean(temp_rednoise_s[[2]])
spectrum(temp_rednoise_s[[2]])
spectrum(temp_rednoise_s[[1]])

arima_mod <- arima(temp_rednoise_s[[1]], order = c(1,0,0))
arima_mod2 <- arima(temp_rednoise_s[[2]], order = c(1,0,0))

r <- subset(r_spat_s,"constant") #base image is at 1 ...
r_stack <- generate_stack_raster(r,nt)

#Prepare to generate images combining time and space
out_suffix_s <- paste("r4_rednoise_test3x3_",out_suffix,sep="")
operation="multiplication"
#undebug(combine_space_time_structure)
#This is output without random component...
r4_rednoise_test3x3 <- convert_multiple_ts_to_raster(list_temp_pattern=temp_rednoise_s,r_stack,
                                                     out_suffix_s,NA_flag_val,file_format,out_dir,operation="multiplication")
  
#r_random_s <- stack(lapply(1:nt,FUN=generate_raster_region,list_param=list_param_gen_raster))
temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
levelplot(r4_rednoise_test3x3,layers=1:nt,col.regions=temp.colors)
r1<-subset(r4_rednoise_test3x3,1)
tt<- r1 - random_r

out_suffix_s <- paste("r4_rednoise_test3x3_",out_suffix,sep="")
out_prefix_str <- "test_3c_3r_"
list_r4 <- mixedsort(create_idrisi_rgf(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix=out_prefix_str))

#Change to zip files in R rather than Linux/MacOs/Unix, use zip from zip Utils R works 
#accross platforms (i.e. Windows)
system_cmd <- paste("zip -r ",out_suffix_s,".zip ", out_suffix_s,sep="")
system(system_cmd)


#############
### Simulate red noise: DATASET 2: this time with size 9x9

#step 1: generate raster image/region

#Now generate random images to add to the sequence...

j <- 45 #number of images
col <- 9 # number of columns in the images 
row <- 9 # number of rows in the images

proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"norm" #c("unif","norm","none")
sd_val<- 1
mean_val<-0
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
#out_suffix <- "gen_10162013"

list_param_gen_raster<-list(j,col,row,proj_str,range_val,NA_flag_val,distribution_val_i,
                            mean_val,sd_val,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i",
                                "mean_val","sd_val","out_suffix","out_dir")
random_r <- generate_raster_region(1,list_param_gen_raster)
plot(random_r) #random spatial image which is the start of the red noise time series.

#generate red noise for every pixels...this should be  modified for large images...

t0_val <- 2
ar1_coef <- 0.9294 #AR1 for MEOT1
nt<-45
temp_test <- gen_ar1_ts_fun(t0_val,ar1_coef,nt)
t0_val <- 1
temp_test2 <- gen_ar1_ts_fun(t0_val,ar1_coef,nt)

temp_rednoise_s <- lapply(values(random_r),FUN=gen_ar1_ts_fun ,ar1_coef=ar1_coef,nt=45,sd_rd=1,mean_rd=0)

plot(temp_rednoise_s[[1]],type="b",col="blue")
lines(temp_rednoise_s[[2]],type="b", col="red")
mean(temp_rednoise_s[[2]])
spectrum(temp_rednoise_s[[2]])
spectrum(temp_rednoise_s[[1]])

arima_mod <- arima(temp_rednoise_s[[1]], order = c(1,0,0))
arima_mod2 <- arima(temp_rednoise_s[[2]], order = c(1,0,0))

####
proj_str <- NA #projection string (use PROJ4 convention or "NA")
range_val <- c(0,1)
distribution_val_i <-"none" #c("unif","norm","none")
sd_val<- 1
mean_val<-0
#distribution_val_i <-"unif" #c("unif","norm","none") 
file_format <-".rst"
NA_flag_val <- -9999
#out_suffix <- "gen_10162013"

list_param_gen_raster<-list(j,col,row,proj_str,range_val,NA_flag_val,distribution_val_i,
                            mean_val,sd_val,out_suffix, out_dir)
names(list_param_gen_raster)<-c("j","col","row","proj_str","range_val","NA_flag_val","distribution_val_i",
                                "mean_val","sd_val","out_suffix","out_dir")
r <- generate_raster_region(1,list_param_gen_raster)

#r <- subset(r_spat_s,"constant") #base image is at 1 ...
r_stack <- generate_stack_raster(r,nt)

#Prepare to generate images combining time and space
out_suffix_s <- paste("r5_rednoise_test9x9_",out_suffix,sep="")
operation="multiplication"
#undebug(combine_space_time_structure)
#This is output without random component...
r5_rednoise_test9x9 <- convert_multiple_ts_to_raster(list_temp_pattern=temp_rednoise_s,r_stack,
                                                     out_suffix_s,NA_flag_val,file_format,out_dir,operation="multiplication")

#r_random_s <- stack(lapply(1:nt,FUN=generate_raster_region,list_param=list_param_gen_raster))
temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
levelplot(r5_rednoise_test9x9,layers=1:nt,col.regions=temp.colors)
r1<-subset(r5_rednoise_test9x9,1)
tt<- r1 - random_r

out_suffix_s <- paste("r5_rednoise_test9x9_",out_suffix,sep="")
out_prefix_str <- "test_9c_9r_"
list_r5 <- mixedsort(create_idrisi_rgf(file_pat="",out_suffix_s,in_dir=out_suffix_s,out_prefix=out_prefix_str))

#Change to zip files in R rather than Linux/MacOs/Unix, use zip from zip Utils R works 
#accross platforms (i.e. Windows)
system_cmd <- paste("zip -r ",out_suffix_s,".zip ", out_suffix_s,sep="")
system(system_cmd)

#####################################################
################    END OF SCRIPT    ##############

