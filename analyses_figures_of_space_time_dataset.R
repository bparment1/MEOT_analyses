########################################       Generation of space-time dataset       #######################################
########################################### For Testing MSSA-MEOT and S-T mode PCA #####################################
#This script performs analyses and produces figures for synthetic space time dataset in R to test EOT,MEOT,PCA and MSSA.
#Space-time series were generated by combining a set of spatial patterns and temporal patterns. 
#This script uses 11 functions stored in a separate file: generation_of_space_time_dataset_functions_12312013.R.
#AUTHORS: Benoit Parmentier                                             
#DATE: 12/31/2013                                                                                
#PROJECT: Clark Labs, MEOT, time series             
#TO DO:
#Write trajectory function...
###################################################################################################

###Loading R library and packages                                                      

library(gtools)   # loading various useful tools such as mixedsort 
library(sp)        #Spatial object models and functionality
library(raster)    #Raster functionality
library(rasterVis) #Raster visualization
library(rgdal)     #GDAL binding
library(vegan) 
library(parallel)   # parallelization based on snow
library(mgcv)                                # GAM package by Simon Wood
library(spdep)                               # Spatial pacakge with methods and spatial stat. by Bivand et al.
library(gstat)                               # Kriging and co-kriging by Pebesma et al.
library(fields)                              # NCAR Spatial Interpolation methods such as kriging, splines
library(foreign)                             # Library for format exchange (e.g. dbf,spss,sas etc.)
library(gdata)                               # various tools with xls reading
library(xts)                                 # basic package for time series analysis
library(zoo)                                 # basic package for time series analysis
library(forecast)                            # package containing ARIMA procedures
library(plotrix)
library(matrixStats) 
library(colorRamps)                         #Color palettes for raster images
##### Functions used in this script #####

functions_generation_space_time_datasets <- "generation_of_space_time_dataset_functions_11252013v6.R"

script_path<-"/Users/benoitparmentier/Dropbox/Data/MEOT_paper/" #path to script
source(file.path(script_path,functions_generation_space_time_datasets)) #source all functions used in this script.

############# Parameters and arguments ####################

out_suffix <-"MEOT_12312013"
in_dir <- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/MEOT12272012/3x3dataset"
out_dir<- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/"

out_dir <- paste(out_dir,out_suffix,sep="_")
if (!file.exists(out_dir)){
  dir.create(out_dir)
  #} else{
  #  out_path <-paste(out_path..)
}
setwd(out_dir)

sine_inDir <- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/MEOT12272012/9x9sine"
MEOT_inDir <- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/MEOT12272012/MEOT_9x9sine"

r_test_sine <- stack(list.files(pattern="Cover9.*.rst$",path=sine_inDir,full.names=T))
r_meot_list <- list.files(pattern="Cover9.*.rst$",path=sine_inDir,full.names=T)

nt <- 45
temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
#levelplot(r_test_sine,layers=1:nt,col.regions=temp.colors)


#Test some palettes
levelplot(r_test_sine,layers=1:9,col.regions=temp.colors(900))
levelplot(r_test_sine,layers=1:9,col.regions=matlab.like(18))
plot(r_test_sine,y=1:9)
plot(r_test_sine,y=1:9, col=temp.colors(25),
     legend.width=2, legend.shrink=0.75)
plot(r_test_sine,y=1:9, 
     legend.width=2, legend.shrink=0.75)

r_agg <- aggregate(r_test_sine,fact=3,fun=mean) #
coords_xy <- coordinates(r_agg)

pix_dat <- t(extract(r_test_sine,coords_xy))
########### Plotting figures ###########

### Figure 1: Original signal...###
#1. images
levelplot(r_test_sine,layers=1:9,col.regions=matlab.like(18))
#2. temporal profiles
#r_dat <- as(r_test_sine,"SpatialPointsDataFrame")

plot(subset(r_test_sine,1),col=matlab.like(18),
     legend.width=2, legend.shrink=0.75)
text(coords_xy[,1],coords_xy[,2],labels=1:9)

plot(as.ts(pix_dat))

### Figure 2: MEOT sequences 9

in_dir<- "/Users/benoitparmentier/Documents/Data/Benoit/Clark_University/Paper_writings/MSSA_BNP/work_dir4_11252013"

#Get all files relevant to components
list_components_folders <- list.dirs(path=in_dir) #default uses recursive and full.names
list_components_folders <- mixedsort(grep("*.components$",list_components_folders,value=T))
list_components_folders <- (grep("sine9by9",list_components_folders,value=T)) #get the sine9by9

pattern_str<- c("sine9by9_L2","sine9by9_L4","sine9by9_L5","sine9by9_L8","sine9by9_L9","sine9by9_L18")
folder_components <-list_components_folders

list_component_files <- mixedsort(list.files(pattern="*.Comp.*.R.rst$",list_components_folders[1]))
list_MEOT_Lag_analyses <- lapply(1:length(pattern_str),function(k){grep(pattern=pattern_str[k],list_component_files,value=TRUE)})

## Plot 

## Quick exploration of results
list_plots_meot_obj <- vector("list",length=length(list_MEOT_Lag_analyses))

out_suffix_s <- paste(pattern_str[1],out_suffix,sep="_") #Lag 2
list_plots_meot_obj[[1]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[1]] ,out_dir,out_suffix_s)
out_suffix_s <- paste(pattern_str[2],out_suffix,sep="_") #Lag 4
list_plots_meot_obj[[2]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[2]] ,out_dir,out_suffix_s)
out_suffix_s <- paste(pattern_str[3],out_suffix,sep="_") #Lag 5
list_plots_meot_obj[[3]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[3]] ,out_dir,out_suffix_s)
out_suffix_s <- paste(pattern_str[4],out_suffix,sep="_") #Lag 8
list_plots_meot_obj[[4]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[4]] ,out_dir,out_suffix_s)
out_suffix_s <- paste(pattern_str[5],out_suffix,sep="_") #Lag 9
list_plots_meot_obj[[5]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[5]] ,out_dir,out_suffix_s)
out_suffix_s <- paste(pattern_str[6],out_suffix,sep="_") #Lag 18
list_plots_meot_obj[[6]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[6]] ,out_dir,out_suffix_s)

### Now combine plots...

pattern_str<- c("sine9by9_L2","sine9by9_L4","sine9by9_L5","sine9by9_L8","sine9by9_L9","sine9by9_L18")
folder_components <-list_components_folders


######### Plot temporal profiles...


## create function to assemble the meot indices in a table...

plot_temporal_components_IDRISI_ETM_proj <-function(folder_components,pattern_str,out_dir,out_suffix){
  #Plot output components from ETM in IDRISI
  
  list_temporal_component_files <- mixedsort(list.files(pattern="*.avl$",folder_components,full.names=T))
  list_temp_profiles <- lapply(1:length(pattern_str),function(k){grep(pattern=pattern_str[k],list_temporal_component_files,value=TRUE)})
  
  #tmp_str <- strsplit(comp_files,"_")
  #comp_str <-unique(unlist(lapply(tmp_str,function(k){grep(pattern="Comp*",k,value=TRUE)})))
  #no_comp <- length(comp_str) #number of components in the analysis
  
  combine_time_profiles_comp<-function(list_time_profiles){
    list_df <- lapply(list_time_profiles,read.table)
    list_df <- lapply(list_df,FUN=function(x){x[,2]})
    df <-do.call(cbind,list_df)
    df <- as.data.frame(df)
    names_str <- paste("comp",1:ncol(df),sep="_")
    names(df)<- names_str
    return(df)
  }
  
  l_df<-lapply(list_temp_profiles,FUN=combine_time_profiles_comp)
  names(l_df) <- pattern_str
  
  ## Now plot...
  list_plots_obj <- vector("list",length=no_comp) 
  
  
}

plot_components_IDRISI_ETM_proj <-function(components_folders,comp_files,out_dir,out_suffix){
  #Plot output components from ETM in IDRISI
    
  tmp_str <- strsplit(comp_files,"_")
  comp_str <-unique(unlist(lapply(tmp_str,function(k){grep(pattern="Comp*",k,value=TRUE)})))
  no_comp <- length(comp_str) #number of components in the analysis
  
  list_MEOT_Lag_analyses_comp <- lapply(1:length(comp_str),function(k){grep(pattern=comp_str[k],comp_files,value=TRUE)})
  
  list_plots_obj <- vector("list",length=no_comp) 
    
  list_raster_name <- vector("list",length=1)
  for(i in 1:length(comp_str)){
    
    comp_str_processed <-comp_str[i]      
    list_r_comp_s <- file.path(folder_components,list_MEOT_Lag_analyses_comp[[i]])
    r_comp_s <- stack(mixedsort(list_r_comp_s))
    layerNames(r_comp_s)<-paste(comp_str_processed,1:nlayers(r_comp_s),sep="_")
    temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
    temp.colors <- matlab.like(18)
    #levelplot(r_stack,layers=1:48, col.regions=temp.colors)
    p <- levelplot(r_comp_s, col.regions=temp.colors,main=paste(comp_str_processed,"_",out_suffix,sep=""))
      
    res_pix<-480
    col_mfrow<-1
    #row_mfrow<-2
    row_mfrow<-1
      
    png_file_name<- paste("Figure_",comp_str_processed,"_",paste(out_suffix,sep=""),".png", sep="")
    png(filename=file.path(out_dir,png_file_name),
        width=col_mfrow*res_pix,height=row_mfrow*res_pix)
    par(mfrow=c(row_mfrow,col_mfrow))
      
    print(p) #plot now
    dev.off()
    
    list_plots_obj[[i]] <- p
    }
  return(list_plots_obj)
}


plot_components_by2_IDRISI_ETM_proj <-function(components_folders,comp_files,out_dir,out_suffix){
  #Plot output components from ETM in IDRISI
  
  tmp_str <- strsplit(comp_files,"_")
  comp_str <-unique(unlist(lapply(tmp_str,function(k){grep(pattern="Comp*",k,value=TRUE)})))
  no_comp <- length(comp_str) #number of components in the analysis
  
  list_MEOT_Lag_analyses_comp <- lapply(1:length(comp_str),function(k){grep(pattern=comp_str[k],comp_files,value=TRUE)})
  
  
  list_raster_name <- vector("list",length=1)
  for(i in 1:length(comp_str)){
    
    comp_str_processed <-comp_str[i]      
    list_r_comp_s <- file.path(folder_components,list_MEOT_Lag_analyses_comp[[i]])
    r_comp_s <- stack(mixedsort(list_r_comp_s))
    layerNames(r_comp_s)<-paste(comp_str_processed,1:nlayers(r_comp_s),sep="_")
    temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
    temp.colors <- matlab.like(18)
    #levelplot(r_stack,layers=1:48, col.regions=temp.colors)
    p <- levelplot(r_comp_s, col.regions=temp.colors,main=paste(comp_str_processed,"_",out_suffix,sep=""))
    
    res_pix<-480
    col_mfrow<-1
    #row_mfrow<-2
    row_mfrow<-1
    
    png_file_name<- paste("Figure_",comp_str_processed,"_",paste(out_suffix,sep=""),".png", sep="")
    png(filename=file.path(out_dir,png_file_name),
        width=col_mfrow*res_pix,height=row_mfrow*res_pix)
    par(mfrow=c(row_mfrow,col_mfrow))
    
    print(p)
    dev.off()
  }
}

#####################################################
################    END OF SCRIPT    ##############

