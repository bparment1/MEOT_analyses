########################################       Generation of space-time dataset       #######################################
########################################### For Testing MSSA-MEOT and S-T mode PCA #####################################
#This script performs analyses and produces figures for synthetic space time datasets in R to test EOT,MEOT,PCA and MSSA.
#Space-time series were generated by combining a set of spatial patterns and temporal patterns. 
#This script uses 11 functions stored in a separate file: generation_of_space_time_dataset_functions_12312013.R.
#AUTHORS: Benoit Parmentier                                             
#DATE CREATED: 12/31/2013 
#DATE MODIFIED: 01/09/2014
#PROJECT: Clark Labs, MEOT, time series             
#TO DO:
###################################################################################################

###Loading R library and packages                                                      

library(gtools)   # loading various useful tools such as mixedsort 
library(sp)        #Spatial object models and functionality
library(raster)    #Raster functionality
library(rasterVis) #Raster visualization
library(rgdal)     #GDAL binding
library(vegan) 
library(parallel)   # parallelization based on snow
library(mgcv)                                # GAM package by Simon Wood
library(spdep)                               # Spatial pacakge with methods and spatial stat. by Bivand et al.
library(gstat)                               # Kriging and co-kriging by Pebesma et al.
library(fields)                              # NCAR Spatial Interpolation methods such as kriging, splines
library(foreign)                             # Library for format exchange (e.g. dbf,spss,sas etc.)
library(gdata)                               # various tools with xls reading
library(xts)                                 # basic package for time series analysis
library(zoo)                                 # basic package for time series analysis
library(forecast)                            # package containing ARIMA procedures
library(plotrix)
library(matrixStats) 
library(colorRamps)                         #Color palettes for raster images
library(gridExtra)

##### Functions used in this script #####

functions_generation_space_time_datasets <- "generation_of_space_time_dataset_functions_11252013v6.R"

script_path<-"/Users/benoitparmentier/Dropbox/Data/MEOT_paper/" #path to script
source(file.path(script_path,functions_generation_space_time_datasets)) #source all functions used in this script.

## create function to assemble the meot indices in a table...

plot_temporal_components_IDRISI_ETM_proj <-function(folder_components,pattern_str,out_dir,out_suffix){
  #Plot output components from ETM in IDRISI
  
  list_temporal_component_files <- mixedsort(list.files(pattern="*.avl$",folder_components,full.names=T))
  list_temp_profiles <- lapply(1:length(pattern_str),function(k){grep(pattern=pattern_str[k],list_temporal_component_files,value=TRUE)})
  
  #tmp_str <- strsplit(comp_files,"_")
  #comp_str <-unique(unlist(lapply(tmp_str,function(k){grep(pattern="Comp*",k,value=TRUE)})))
  #no_comp <- length(comp_str) #number of components in the analysis
  
  combine_time_profiles_comp<-function(list_time_profiles){
    list_df <- lapply(list_time_profiles,read.table)
    list_df <- lapply(list_df,FUN=function(x){x[,2]})
    df <-do.call(cbind,list_df)
    df <- as.data.frame(df)
    names_str <- paste("comp",1:ncol(df),sep="_")
    names(df)<- names_str
    return(df)
  }
  
  l_df<-lapply(list_temp_profiles,FUN=combine_time_profiles_comp)
  names(l_df) <- pattern_str
  
  ## Now plot...
  #list_plots_obj <- vector("list",length=no_comp) 
  return(l_df)
  
}

plot_components_IDRISI_ETM_proj <-function(components_folders,comp_files,out_dir,out_suffix){
  #Plot output components from ETM in IDRISI
  
  tmp_str <- strsplit(comp_files,"_")
  comp_str <-unique(unlist(lapply(tmp_str,function(k){grep(pattern="Comp*",k,value=TRUE)})))
  no_comp <- length(comp_str) #number of components in the analysis
  
  list_MEOT_Lag_analyses_comp <- lapply(1:length(comp_str),function(k){grep(pattern=comp_str[k],comp_files,value=TRUE)})
  
  list_plots_obj <- vector("list",length=no_comp) 
  
  list_raster_name <- vector("list",length=1)
  for(i in 1:length(comp_str)){
    
    comp_str_processed <-comp_str[i]      
    list_r_comp_s <- file.path(folder_components,list_MEOT_Lag_analyses_comp[[i]])
    r_comp_s <- stack(mixedsort(list_r_comp_s))
    layerNames(r_comp_s)<-paste(comp_str_processed,1:nlayers(r_comp_s),sep="_")
    temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
    temp.colors <- matlab.like(18)
    #levelplot(r_stack,layers=1:48, col.regions=temp.colors)
    p <- levelplot(r_comp_s, col.regions=temp.colors,main=paste(comp_str_processed,"_",out_suffix,sep=""))
    
    res_pix<-480
    col_mfrow<-1
    #row_mfrow<-2
    row_mfrow<-1
    
    png_file_name<- paste("Figure_",comp_str_processed,"_",paste(out_suffix,sep=""),".png", sep="")
    png(filename=file.path(out_dir,png_file_name),
        width=col_mfrow*res_pix,height=row_mfrow*res_pix)
    par(mfrow=c(row_mfrow,col_mfrow))
    
    print(p) #plot now
    dev.off()
    
    list_plots_obj[[i]] <- p
  }
  return(list_plots_obj)
}


plot_components_by2_IDRISI_ETM_proj <-function(components_folders,comp_files,out_dir,out_suffix){
  #Plot output components from ETM in IDRISI
  
  tmp_str <- strsplit(comp_files,"_")
  comp_str <-unique(unlist(lapply(tmp_str,function(k){grep(pattern="Comp*",k,value=TRUE)})))
  no_comp <- length(comp_str) #number of components in the analysis
  
  list_MEOT_Lag_analyses_comp <- lapply(1:length(comp_str),function(k){grep(pattern=comp_str[k],comp_files,value=TRUE)})
  
  
  list_raster_name <- vector("list",length=1)
  for(i in 1:length(comp_str)){
    
    comp_str_processed <-comp_str[i]      
    list_r_comp_s <- file.path(folder_components,list_MEOT_Lag_analyses_comp[[i]])
    r_comp_s <- stack(mixedsort(list_r_comp_s))
    layerNames(r_comp_s)<-paste(comp_str_processed,1:nlayers(r_comp_s),sep="_")
    temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
    temp.colors <- matlab.like(18)
    #levelplot(r_stack,layers=1:48, col.regions=temp.colors)
    p <- levelplot(r_comp_s, col.regions=temp.colors,main=paste(comp_str_processed,"_",out_suffix,sep=""))
    
    res_pix<-480
    col_mfrow<-1
    #row_mfrow<-2
    row_mfrow<-1
    
    png_file_name<- paste("Figure_",comp_str_processed,"_",paste(out_suffix,sep=""),".png", sep="")
    png(filename=file.path(out_dir,png_file_name),
        width=col_mfrow*res_pix,height=row_mfrow*res_pix)
    par(mfrow=c(row_mfrow,col_mfrow))
    
    print(p)
    dev.off()
  }
}

############# Parameters and arguments ####################

out_suffix <-"MEOT_01092014"
in_dir <- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/MEOT12272012/3x3dataset"
out_dir<- "/Users/benoitparmentier/Documents/DATA/Benoit/Clark_University/Paper_writings/MSSA_BNP/"

out_dir_name <- paste("analyses_and_figures","_",out_suffix,sep="")
out_dir <- file.path(out_dir,out_dir_name)
if (!file.exists(out_dir)){
  dir.create(out_dir)
  #} else{
  #  out_path <-paste(out_path..)
}
setwd(out_dir)


############## PART I : MEOT WITH SINUSOIDAL PATTERN ###############


sine_inDir <- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/MEOT12272012/9x9sine"
MEOT_inDir <- "/Users/benoitparmentier/Dropbox/Data/MEOT_paper/MEOT12272012/MEOT_9x9sine"

r_test_sine <- stack(list.files(pattern="Cover9.*.rst$",path=sine_inDir,full.names=T))

#r_meot_list <- list.files(pattern="Cover9.*.rst$",path=sine_inDir,full.names=T)

nt <- 45
temp.colors <- colorRampPalette(c('blue', 'white', 'red'))
#levelplot(r_test_sine,layers=1:nt,col.regions=temp.colors)

r_agg <- aggregate(r_test_sine,fact=3,fun=mean) #
coords_xy <- coordinates(r_agg)

pix_dat <- t(extract(r_test_sine,coords_xy))

########### Plotting figures ###########

### Figure 1: Original signal...###
#1. images

layout_m <- c(1,1)
png(paste("Figure1a","original_sine","_paper_revisions_supplement_",out_suffix,".png", sep=""),
    height=480*layout_m[1],width=480*layout_m[2]*1)
#height=3*480*layout_m[1],width=2*480*layout_m[2])
#height=480*6,width=480*4)
#par(mfrow=layout_m)    
names_panel_plot <- paste("T",1:9,sep="_")
levelplot(r_test_sine,layers=1:9,col.regions=matlab.like(18),
          par.settings = list(strip=strip.custom(factor.levels=names_panel_plot)))
dev.off()
#2. temporal profiles
#r_dat <- as(r_test_sine,"SpatialPointsDataFrame")
layout_m <- c(1,1)
png(paste("Figure1b","original_image_time_series_1","_paper_revisions_supplement_",out_suffix,".png", sep=""),
    height=480*layout_m[1],width=480*layout_m[2]*1)

plot(subset(r_test_sine,1),col=matlab.like(18),
     legend.width=2, legend.shrink=0.75)
text(coords_xy[,1],coords_xy[,2],labels=c(1,2,3,9,8,7,4,5,6))
#text(coords_xy[,1],coords_xy[,2],labels=1:9)
dev.off()

png(paste("Figure1c","original_sine_time_series","_paper_revisions_supplement_",out_suffix,".png", sep=""),
    height=480*layout_m[1],width=480*layout_m[2]*1)

plot(as.ts(pix_dat),main="Pixels time series")

dev.off()

### Figure 2: MEOT sequences 9

in_dir<- "/Users/benoitparmentier/Documents/Data/Benoit/Clark_University/Paper_writings/MSSA_BNP/work_dir4_11252013"

#Get all files relevant to components
list_components_folders <- list.dirs(path=in_dir) #default uses recursive and full.names
list_components_folders <- mixedsort(grep("*.components$",list_components_folders,value=T))
list_components_folders <- (grep("sine9by9",list_components_folders,value=T)) #get the sine9by9

pattern_str<- c("sine9by9_L2","sine9by9_L4","sine9by9_L5","sine9by9_L6","sine9by9_L8","sine9by9_L9","sine9by9_L18")
folder_components <-list_components_folders

list_component_files <- mixedsort(list.files(pattern="*.Comp.*.R.rst$",list_components_folders[1]))
list_MEOT_Lag_analyses <- lapply(1:length(pattern_str),function(k){grep(pattern=pattern_str[k],list_component_files,value=TRUE)})

## Plot 

## Quick exploration of results
list_plots_meot_obj <- vector("list",length=length(list_MEOT_Lag_analyses))

#put this in a loop..
for  (i in 1:length(list_plots_meot_obj)){
  out_suffix_s <- paste(pattern_str[i],out_suffix,sep="_") #Lag 2,Lag4 ... to Lag 18
  list_plots_meot_obj[[i]] <- plot_components_IDRISI_ETM_proj(folder_components,comp_files=list_MEOT_Lag_analyses[[i]] ,out_dir,out_suffix_s)
}

#out_suffix_s <- paste(pattern_str[1],out_suffix,sep="_") #Lag 2
#list_plots_meot_obj[[1]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[1]] ,out_dir,out_suffix_s)
#out_suffix_s <- paste(pattern_str[2],out_suffix,sep="_") #Lag 4
#list_plots_meot_obj[[2]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[2]] ,out_dir,out_suffix_s)
#out_suffix_s <- paste(pattern_str[3],out_suffix,sep="_") #Lag 5
#list_plots_meot_obj[[3]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[3]] ,out_dir,out_suffix_s)
#out_suffix_s <- paste(pattern_str[4],out_suffix,sep="_") #Lag 6
#list_plots_meot_obj[[4]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[3]] ,out_dir,out_suffix_s)
#out_suffix_s <- paste(pattern_str[5],out_suffix,sep="_") #Lag 8
#list_plots_meot_obj[[5]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[4]] ,out_dir,out_suffix_s)
#out_suffix_s <- paste(pattern_str[6],out_suffix,sep="_") #Lag 9
#list_plots_meot_obj[[6]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[5]] ,out_dir,out_suffix_s)
#out_suffix_s <- paste(pattern_str[7],out_suffix,sep="_") #Lag 18
#list_plots_meot_obj[[7]] <- plot_components_IDRISI_ETM_proj(components_folders,comp_files=list_MEOT_Lag_analyses[[6]] ,out_dir,out_suffix_s)#

### Now combine plots...

pattern_str<- c("sine9by9_L2","sine9by9_L4","sine9by9_L5","sine9by9_L6","sine9by9_L8","sine9by9_L9","sine9by9_L18")
folder_components <-list_components_folders

title_plots <- c("Lag window 2 MEOT","Lag window 4 MEOT", "Lag window 5 MEOT", "Lag window 6 MEOT",
                "Lag window 8 MEOT","Lag window 9 MEOT","Lag window 18 MEOT")

for (i in 1:length(list_plots_meot_obj)){
  layout_m <- c(1,1)
  no_fig <-i+1
  png(paste("Figure",no_fig,"_paper_revisions_supplement_",out_suffix,".png", sep=""),
      height=480*layout_m[1],width=480*layout_m[2]*2)
  #height=3*480*layout_m[1],width=2*480*layout_m[2])
  #height=480*6,width=480*4)
  #par(mfrow=layout_m)    

  p_comp1 <- list_plots_meot_obj[[i]][[1]] 
  p_comp2 <- list_plots_meot_obj[[i]][[2]] 
  
  p_comp1$main <- paste(title_plots[[i]],1,sep="")
  p_comp2$main <- paste(title_plots[[i]],2,sep="")
  grid.arrange(p_comp1,p_comp2,ncol=2)
  
  dev.off()
  
}

######### Plot temporal profiles...

l_df <- plot_temporal_components_IDRISI_ETM_proj(folder_components,pattern_str,out_dir,out_suffix) 

pattern_str<- c("sine9by9_L2","sine9by9_L4","sine9by9_L5","sine9by9_L8","sine9by9_L9","sine9by9_L18")
folder_components <-list_components_folders


title_plots <- c("Lag window 2 MEOT","Lag window 4 MEOT", "Lag window 5 MEOT",
                 "Lag window 8 MEOT","Lag window 9 MEOT","Lag window 18 MEOT")
for (i in 1:length(l_df)){
  df <-l_df[[i]]
  layout_m <- c(1,1)
  no_fig <-i+1
  png(paste("Figure",no_fig,"_temporal_MEOT_paper_revisions_supplement_",out_suffix,".png", sep=""),
      height=480*layout_m[1],width=960*layout_m[2]*2)
  #height=3*480*layout_m[1],width=2*480*layout_m[2])
  #height=480*6,width=480*4)
  #par(mfrow=layout_m)    

  plot(df[,1],type="b",lty="solid",col="blue",main=paste(title_plots[[i]],1,sep=""))
  lines(df[,2],type="b",lty="dashed",co="darkgreen")
  
  legend("topleft",legend=c("MEOT1","MEOT2"), cex=0.8, col=c("blue","darkgreen"),
         lty=c(1,2),lwd=2)  #lwd=line width
  dev.off()
}



############## PART II : RED NOISE ANALYSIS ###############

### ORIGINAL RED NOISE DATASET

rednoise_inDir <- "/Users/benoitparmentier/Documents/Data/Benoit/Clark_University/Paper_writings/MSSA_BNP/work_dir4_11252013/r2_rednoise_AR92_trend_x_gen_11252013"
r_test_rednoise <- stack(list.files(pattern="r2_rednoise_AR92_trend_x.*.rst$",path=rednoise_inDir,full.names=T))

nt <- 45

#Test some palettes
levelplot(r_test_rednoise,layers=1:9,col.regions=matlab.like(18))

r_agg <- aggregate(r_test_sine,fact=3,fun=mean) #
coords_xy <- coordinates(r_agg)

#rednoise_pix_dat <- as(r_test_rednoise,"SpatialPointsDataFrame")
rednoise_pix_dat <- as.matrix(r_test_rednoise)#,"SpatialPointsDataFrame")
rednoise_pix_dat <- t(rednoise_pix_dat)

########### Plotting figures ###########

### Figure 1: Original signal...###
#1. images
levelplot(r_test_rednoise ,layers=1:9,col.regions=matlab.like(18))
#2. temporal profiles
#r_dat <- as(r_test_sine,"SpatialPointsDataFrame")

plot(subset(r_test_sine,1),col=matlab.like(18),
     legend.width=2, legend.shrink=0.75)
text(coords_xy[,1],coords_xy[,2],labels=1:9)
#text(coords_xy[,1],coords_xy[,2],labels=1:9)

plot(as.ts(rednoise_pix_dat),main="Red noise dataset pixel time series")


in_dir<- "/Users/benoitparmentier/Documents/Data/Benoit/Clark_University/Paper_writings/MSSA_BNP/work_dir4_11252013"

#Get all files relevant to components
list_components_folders <- list.dirs(path=in_dir) #default uses recursive and full.names
list_components_folders <- mixedsort(grep("*.components$",list_components_folders,value=T))
folder_components <- (grep("rednoise_AR92_trend_x_gen_11252013",list_components_folders,value=T)) #get the sine9by9

pattern_str<- c("r2_rednoise_AR92_trend_x")

list_component_files <- mixedsort(list.files(pattern="*.Comp.*.R.rst$",folder_components))
list_MEOT_Lag_analyses_rednoise <- lapply(1:length(pattern_str),function(k){grep(pattern=pattern_str[k],list_component_files,value=TRUE)})
list_MEOT_Lag_analyses_rednoise[[1]] <- list_MEOT_Lag_analyses_rednoise[[1]][1:45]
## Plot 

## Quick exploration of results
list_plots_meot_rednoise_obj <- vector("list",length=length(list_MEOT_Lag_analyses_rednoise))

out_suffix_s <- paste(pattern_str[1],out_suffix,sep="_") #Lag 9
list_plots_meot_rednoise_obj[[1]] <- plot_components_IDRISI_ETM_proj(components_folders,
                                                            comp_files=list_MEOT_Lag_analyses_rednoise[[1]] ,out_dir,out_suffix_s)

list_plots_meot_rednoise_obj[[1]][[5]]

title_plots <- c("Lag window 9 MEOT")

for (i in 1:length(list_plots_meot_rednoise_obj)){
  plot_obj <- list_plots_meot_rednoise_obj[[i]]
  layout_m <- c(1,1)
  no_fig <-i+1
  png(paste("Figure",no_fig,"_rednoise_paper_revisions_supplement_",out_suffix,".png", sep=""),
      height=480*layout_m[1],width=480*layout_m[2]*2)
  #height=3*480*layout_m[1],width=2*480*layout_m[2])
  #height=480*6,width=480*4)
  #par(mfrow=layout_m)    
  
  p_comp1 <- plot_obj[[1]] 
  p_comp2 <- plot_obj[[2]] 
  
  p_comp1$main <- paste(title_plots[[i]],1,sep="")
  p_comp2$main <- paste(title_plots[[i]],2,sep="")
  grid.arrange(p_comp1,p_comp2,ncol=2)
  
  dev.off()
  
}

### Now temporal profiles...
pattern_str<- c("r2_rednoise_AR92_trend_x")
l_rednoise_df <- plot_temporal_components_IDRISI_ETM_proj(folder_components,pattern_str,out_dir,out_suffix) 

#pattern_str<- c("sine9by9_L2","sine9by9_L4","sine9by9_L5","sine9by9_L8","sine9by9_L9","sine9by9_L18")
#folder_components <-list_components_folders

title_plots <- c("Lag window 9 MEOT")

for (i in 1:length(l_rednoise_df)){
  df <-l_rednoise_df[[i]]
  layout_m <- c(1,1)
  no_fig <-i+1
  png(paste("Figure",no_fig,"_rednoise_temporal_MEOT_paper_revisions_supplement_",out_suffix,".png", sep=""),
      height=480*layout_m[1],width=960*layout_m[2]*2)
  #height=3*480*layout_m[1],width=2*480*layout_m[2])
  #height=480*6,width=480*4)
  #par(mfrow=layout_m)    
  
  plot(df[,1],type="b",lty="solid",col="blue",main=paste(title_plots[[i]],1,sep=""))
  lines(df[,2],type="b",lty="dashed",co="darkgreen")
  
  legend("topleft",legend=c("MEOT1","MEOT2"), cex=0.8, col=c("blue","darkgreen"),
         lty=c(1,2),lwd=2)  #lwd=line width
  dev.off()
}



############## END OF SCRIPT ##########


#####################################################
################    END OF SCRIPT    ##############

